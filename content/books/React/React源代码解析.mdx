---
title: "React æ ¸å¿ƒåŸç†ï¼šFiberæ¶æ„ã€è°ƒåº¦æœºåˆ¶ä¸Hookå®ç°"
date: "2024-06-23"
summary: "æ·±å…¥è§£æReactåº•å±‚å®ç°ï¼ŒåŒ…æ‹¬Fiberæ¶æ„è®¾è®¡ã€åŒç¼“å­˜æœºåˆ¶ã€è°ƒåº¦å™¨åŸç†ã€Diffç®—æ³•ä¼˜åŒ–ã€Hookå·¥ä½œæµç¨‹åŠå¹¶å‘æ›´æ–°ç‰¹æ€§ã€‚"
status: "completed"
tech: ["React", "Fiber", "Scheduler"]
github: "https://github.com/BM-laoli"
arxiv: ""
keyId: "React"
---

> å¯¹React ä½¿ç”¨åˆ°äº†ä¸€å®šçš„ç¨‹åº¦ ä¹‹åï¼Œä½ åº”è¯¥å¥½å¥½çš„å­¦ä¹ ä¸€ä¸‹å®ƒçš„åº•å±‚å®ç°åŸç†äº†ï¼ˆå¦‚æœä½ ä¸€ç›´åœ¨ä½¿ç”¨React é‚£ä¹ˆä½ ç»å¯¹éœ€è¦çš„ï¼‰ï¼Œè¯¾ç¨‹æ¥è‡ª å¡ç¥çš„ è§£æ [ReactæŠ€æœ¯æ­ç§˜](https://react.iamkasong.com/)[è‡ªé¡¶å‘ä¸‹å­¦ React æºç  - æ€å¦ç¼–ç¨‹ - å­¦ç¼–ç¨‹ï¼Œæ¥æ€å¦ï¼Œå‡èŒåŠ è–ªå¿«äººä¸€æ­¥](https://ke.segmentfault.com/course/1650000023864436/section/1500000023864578)
>



# ç†å¿µ
Reactçš„å®šä½æ˜¯ä¸€ä¸ªâ€œ**<font style="color:#ED740C;">å¿«é€Ÿå“åº”çš„UIåº“ è€Œä¸æ˜¯å¤§ä¸€æ¡¶çš„æ¡†æ¶</font>**â€ï¼Œå…³é”®å­—ï¼šâ€œ<font style="color:#ED740C;">å¿«é€Ÿå“åº”å°±è¦å…‹æœ(CPU/IO ç“¶é¢ˆ)â€œ,</font>

+ CPUç“¶é¢ˆ

 ä¸»æµæµè§ˆå™¨å¸§æ•°ä¸º 60FPSï¼Œä¹Ÿå°±æ˜¯ 16.6ms ä¸€å¸§ï¼Œå¦‚æœè¿™ä¸€å¸§ JSæ‰§è¡Œè¿‡é•¿ä¼šè€Œæ¸²æŸ“æ²¡æœ‰è·Ÿä¸Šï¼Œä¼šå¯¼è‡´æ¸²æŸ“ä¸æµç•…ã€‚ä¸€èˆ¬çš„è§£å†³æ˜¯ é˜²æŠ–å’Œæˆªæµï¼ˆæœ¬è´¨ä¸Šéƒ½æ˜¯é™åˆ¶æˆ‘ä»¬æ›´æ–°çš„é¢‘ç‡ï¼Œè€Œä¸”ä½“éªŒä¸å¥½ æ‰å¸§ï¼‰ï¼ŒReactæœ€æ–°ç‰ˆæœ¬è§£å†³æ–¹æ¡ˆï¼š**<font style="color:#DF2A3F;">å¼‚æ­¥å¯ä¸­æ–­çš„æ›´æ–°</font>**

+ IOç“¶é¢ˆ

å°†äººé™…äº¤äº’çš„ç»“æœ åº”ç”¨åˆ°UIä¸­ï¼Œå»æ‰è¿‡å¤šçš„ ä¸­é—´loading çŠ¶æ€ï¼Œè®©ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°loading....(åœ¨æŸäº›æ–¹æ¡ˆ).  è¿™ä¸ªæ˜¯ä¹‹å‰çš„æ–¹æ¡ˆï¼Œç›®å‰React å·²ç»æ¨å‡ºçš„æ–°çš„æŠ€æœ¯ â€œ**<font style="color:#DF2A3F;">å¼‚æ­¥çš„å¯ä¸­æ–­çš„æ›´æ–°â€</font>**



## æ–°çš„è€çš„æ¶æ„
> ä¸»è¦æ¥å” å—‘ä¸€ä¸‹æ–°çš„ vs è€çš„ çš„ç‰¹ç‚¹å’Œå·¥ä½œæµç¨‹
>

Reactçš„æ—§ç‰ˆæœ¬æ¶æ„ï¼šä¸¤å±‚è®¾è®¡ åè°ƒå™¨ï¼ˆä»€ä¹ˆç»„ä»¶éœ€è¦æ¸²æŸ“ ï¼‰ Reconcilerï¼ˆæ‰¾å˜åŒ–ï¼‰ / æ¸²æŸ“å™¨ Renderï¼ˆæ‰§è¡Œæ¸²æŸ“ï¼‰

ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705234134840-5441256f-c985-44fb-aa0d-140803f8de4c.png)

å¦‚æœåœ¨React15 å‘ç”Ÿäº† â€œæ›´æ–°ä¸­æ–­â€ä¼šå¯¼è‡´BUG

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705234240196-68487651-45fb-4514-9098-e904974180f5.png)



Reactçš„æ–°ç‰ˆæœ¬çš„æ¶æ„ï¼š<font style="color:rgb(44, 62, 80);">Scheduler(è°ƒåº¦å™¨ è°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥</font>**<font style="color:rgb(44, 62, 80);">Reconciler</font>**<font style="color:rgb(44, 62, 80);">) + Reconciler + Renderï¼›</font>

Reconcilerçš„å·¥ä½œå¤§æ¦‚å·¥ä½œæµç¨‹ï¼Œrenderçš„å¤§è‡´å·¥ä½œæµç¨‹ï¼Œ

å¯ä¸­æ–­çš„å¾ªç¯è¿‡ç¨‹ã€‚React16 ä¸‹çš„ Stateæ˜¯å¦‚ä½•æ›´æ–°çš„ï¼Ÿ

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705234308308-257605a9-64dc-4f9b-a69e-b5ebbc2c3b42.png)



<font style="color:rgb(71, 101, 130);">Reconciler</font><font style="color:rgb(44, 62, 80);">å†…éƒ¨é‡‡ç”¨äº†</font><font style="color:rgb(71, 101, 130);">Fiber</font><font style="color:rgb(44, 62, 80);">çš„æ¶æ„ï¼Œ15è€çš„æ¶æ„å°±æ˜¯åŒæ­¥æ›´æ–°çš„åšæ³•ï¼Œ16ä¹‹åçš„å°±æ˜¯â€œå¯ä¸­æ–­çš„å¼‚æ­¥æ›´æ–°â€</font>

<font style="color:rgb(44, 62, 80);"></font>

## <font style="color:rgb(44, 62, 80);">Fiberçš„æ¶æ„çš„å®ç°åŸç†</font>
<font style="color:rgb(71, 101, 130);">ä»£æ•°æ•ˆåº”</font><font style="color:rgb(44, 62, 80);">ï¼ˆAlgebraic Effects ä¸»è¦çš„ç›®çš„å°±æ˜¯æŠŠå‰¯ä½œç”¨åˆ†ç¦»ï¼‰ï¼Œå’Œå‡½æ•°å¼ç¼–ç¨‹çš„å¤ä¹ ï¼›</font>

<font style="color:rgb(71, 101, 130);">çº¤ç¨‹</font><font style="color:rgb(44, 62, 80);">ä¸è¿›ç¨‹ï¼ˆProcessï¼‰çº¿ç¨‹ï¼ˆThreadï¼‰åç¨‹ï¼ˆCoroutine jsä¸­å·²ç»æœ‰å®ç°äº†generateï¼‰åŒä¸ºç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒFiberçš„å«ä¹‰æœ‰ä¸‰ï¼Œä½œä¸ºæ¶æ„ï¼Œä½œä¸ºæ•°æ®ç»“æ„ ï¼Œä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒã€‚</font><font style="color:rgb(153, 153, 153);">ç”¨</font><font style="color:rgb(71, 101, 130);">return</font><font style="color:rgb(153, 153, 153);">æŒ‡ä»£çˆ¶çº§èŠ‚ç‚¹ã€‚</font>

ä¼˜å…ˆçº§çš„è¦ç‚¹ï¼š**<font style="color:#DF2A3F;">æ›´æ–°å¯ä»¥ä¸­æ–­ï¼Œé«˜ä¼˜å…ˆçº§å¯ä»¥å–ä»£ä½ä¼˜å…ˆçº§ å…ˆæ›´æ–°</font>**

<font style="color:rgb(153, 153, 153);"></font>

## Fiberæ¶æ„çš„å·¥ä½œåŸç†
Fieber

<font style="color:rgb(44, 62, 80);">åœ¨å†…å­˜ä¸­ç›´æ¥æ„å»ºtreeå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯=åŒç¼“å†²æŠ€æœ¯ï¼ˆ</font><font style="color:rgb(71, 101, 130);">React</font><font style="color:rgb(44, 62, 80);">ä½¿ç”¨â€œåŒç¼“å­˜â€æ¥å®Œæˆ</font><font style="color:rgb(71, 101, 130);">Fiberæ ‘</font><font style="color:rgb(44, 62, 80);">çš„æ„å»ºä¸æ›¿æ¢â€”â€”å¯¹åº”ç€</font><font style="color:rgb(71, 101, 130);">DOMæ ‘</font><font style="color:rgb(44, 62, 80);">çš„åˆ›å»ºä¸æ›´æ–°ã€‚</font>

<font style="color:rgb(44, 62, 80);">æ–°fiberå’Œæ—§fiberé€šè¿‡ å±æ€§ </font><font style="color:rgb(71, 101, 130);">alternate è¿›è¡Œè¿æ¥</font>

<font style="color:rgb(71, 101, 130);">current Fiber tree <- alternate -> workInProgress tree,</font>



ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„fiberä¾‹å­

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705235369863-548817a5-8e41-4487-94be-354613954097.png)

å…³äºfiberçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```tsx
function FiberNode(
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // ä½œä¸ºé™æ€æ•°æ®ç»“æ„çš„å±æ€§
   // Fiberå¯¹åº”ç»„ä»¶çš„ç±»å‹ Function/Class/Host...
  this.tag = tag;
  // keyå±æ€§
  this.key = key;
  // å¤§éƒ¨åˆ†æƒ…å†µåŒtypeï¼ŒæŸäº›æƒ…å†µä¸åŒï¼Œæ¯”å¦‚FunctionComponentä½¿ç”¨React.memoåŒ…è£¹
  this.elementType = null;
  // å¯¹äº FunctionComponentï¼ŒæŒ‡å‡½æ•°æœ¬èº«ï¼Œå¯¹äºClassComponentï¼ŒæŒ‡classï¼Œå¯¹äºHostComponentï¼ŒæŒ‡DOMèŠ‚ç‚¹tagName
  this.type = null;
  // Fiberå¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹
  this.stateNode = null;

  // ç”¨äºè¿æ¥å…¶ä»–FiberèŠ‚ç‚¹å½¢æˆFiberæ ‘
  this.return = null;
  this.child = null;
  this.sibling = null;
  this.index = 0;

  this.ref = null;

  // ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒçš„å±æ€§
  // ä¿å­˜æœ¬æ¬¡æ›´æ–°é€ æˆçš„çŠ¶æ€æ”¹å˜ç›¸å…³ä¿¡æ¯
  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;
  this.memoizedState = null;
  this.dependencies = null;
  
  this.mode = mode;
  
  // ä¿å­˜æœ¬æ¬¡æ›´æ–°ä¼šé€ æˆçš„DOMæ“ä½œ
  this.effectTag = NoEffect;
  this.nextEffect = null;
  
  this.firstEffect = null;
  this.lastEffect = null;
  

  // è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³
  this.lanes = NoLanes;
  this.childLanes = NoLanes;

  // æŒ‡å‘è¯¥fiberåœ¨å¦ä¸€æ¬¡æ›´æ–°æ—¶å¯¹åº”çš„fiber
  this.alternate = null;
}
```

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">ä¸€ä¸ªç®€å•çš„ mount å’Œupdateçš„æµç¨‹ä»‹ç»ï¼Œå¯¹äºæ–°çš„æ¶æ„æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„å‡ ä¸ªé‡è¦æ¦‚å¿µ</font>

+ <font style="color:#DF2A3F;">Scheduler å’Œtask è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³</font>
+ <font style="color:#DF2A3F;">Recociler å·¥ä½œé˜¶æ®µè¢«ç§°ä¸ºrendré˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µè°ƒç”¨ renderæ–¹æ³•</font>
+ <font style="color:#DF2A3F;">Render  è¢«ç§°ä¸º commit é˜¶æ®µï¼Œå®ƒä¼šæŠŠrender é˜¶æ®µæäº¤è¿‡æ¥çš„ä¸œè¥¿ æ¸²æŸ“å‡ºå»</font>
+ <font style="color:#DF2A3F;">ä¸Šé¢çš„é˜¶æ®µ ç»Ÿç§°ä¸ºwork</font>

## <font style="color:rgb(44, 62, 80);">Reactæºä»£ç çš„ç›®å½•ç»“æ„åŠè°ƒè¯•</font>
### å¦‚ä½•åœ¨æœ¬åœ°æ„å»ºReactLibï¼Ÿ
é¦–å…ˆä½ éœ€è¦äº†è§£yarn link æ“ä½œï¼š  
å½“ä½ åœ¨YarnåŒ…ç®¡ç†å™¨ä¸­è¿è¡Œyarn linkæ—¶ï¼Œå®ƒä¼šåœ¨åŒ…ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚è¿™åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¾ˆæœ‰ç”¨ï¼Œå½“ä½ æƒ³è¦åœ¨å¦ä¸€ä¸ªé¡¹ç›®çš„ä¸Šä¸‹æ–‡ä¸­æµ‹è¯•å¯¹ä¸€ä¸ªåŒ…çš„æ›´æ”¹æ—¶ï¼Œè€Œä¸å¿…å°†è¯¥åŒ…å‘å¸ƒåˆ°æ³¨å†Œè¡¨ä¸­ã€‚é“¾æ¥çš„åŒ…ç„¶ååœ¨é¡¹ç›®ä¸­è¢«ç”¨ä½œå¸¸è§„ä¾èµ–é¡¹ã€‚

å¦‚æœä½ æƒ³è¿˜åŸå›å»ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ­¥éª¤ï¼š

1. yarn è¿˜åŸ

```shell
# yarn è¿˜åŸ
$ yarn unlink
# å¸è½½æœ¬åœ°é¡¹ç›®åŒ…
$ yarn remove package-name
# é‡æ–°å®‰è£…åŒ…
$ yarn add package-name
```



ç„¶åæˆ‘ä»¬å†æ¥è®² å¦‚ä½•æŠŠreactæ‹‰åˆ°æœ¬åœ°è¿›è¡Œæ„å»ºå’Œbuild ä»¥åŠlinkã€‚

```shell
# git clone react
git clone https://github.com/facebook/react.git


# yarn & build æ‰“åŒ…æˆcjsç‰ˆæœ¬ ç„¶ålinkåˆ°yarnæœ¬åœ°
cd react
yarn 

yarn build react/index,react/jsx,react-dom/index,scheduler --type=NODE

cd build/node_modules/react

# ç”³æ˜reactæŒ‡å‘
yarn link
cd build/node_modules/react-dom
# ç”³æ˜react-domæŒ‡å‘
yarn link

# create ä¸€ä¸ªreacté¡¹ç›®ï¼Œå¹¶ä¸”checkä¸€ä¸‹çœ‹çœ‹æ˜¯å¦è¿æ¥åˆ°æœ¬é˜Ÿçš„react äº†å»äº†
npx create-react-app a-react-demo
cd  a-react-demo
yarn link eact react-dom

# å¤§éƒ¨åˆ†åŒå­¦åº”è¯¥éƒ½æ‰§è¡Œä¸äº†ä¸Šé¢çš„å…¨æµç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œç»™ä¸€ä¸ªå¡è€å¸ˆçš„æ„å»ºå¥½çš„åŒ… ç›´æ¥å»yarn linkå§
git clone https://gitee.com/kasong/react 

```



æºç ç›®å½•å’Œå…³é”®ç‚¹ï¼š

```plain
æ ¹ç›®å½•
â”œâ”€â”€ fixtures        # åŒ…å«ä¸€äº›ç»™è´¡çŒ®è€…å‡†å¤‡çš„å°å‹ React æµ‹è¯•é¡¹ç›®
â”œâ”€â”€ packages        # åŒ…å«å…ƒæ•°æ®ï¼ˆæ¯”å¦‚ package.jsonï¼‰å’Œ React ä»“åº“ä¸­æ‰€æœ‰ package çš„æºç ï¼ˆå­ç›®å½• srcï¼‰
â”œâ”€â”€ scripts         # å„ç§å·¥å…·é“¾çš„è„šæœ¬ï¼Œæ¯”å¦‚gitã€jestã€eslintç­‰
```

ä¸‹é¢çš„æ˜¯ä» package reactä¸­æ¥çš„ 

+ <font style="color:rgb(44, 62, 80);">React.createElement</font>
+ <font style="color:rgb(44, 62, 80);">React.Component</font>
+ <font style="color:rgb(44, 62, 80);">React.Children</font>

è¿™äº› API æ˜¯å…¨å¹³å°é€šç”¨çš„ï¼Œå®ƒä¸åŒ…å«<font style="color:rgb(71, 101, 130);">ReactDOM</font>ã€<font style="color:rgb(71, 101, 130);">ReactNative</font>ç­‰å¹³å°ç‰¹å®šçš„ä»£ç ã€‚åœ¨ NPM ä¸Šä½œä¸º[å•ç‹¬çš„ä¸€ä¸ªåŒ…](https://www.npmjs.com/package/react)å‘å¸ƒã€‚

```latex
- Scheduler
- react-reconciler

```

```plain
react-server        # åˆ›å»ºè‡ªå®šä¹‰SSRæµ
- react-client        # åˆ›å»ºè‡ªå®šä¹‰çš„æµ
- react-fetch         # ç”¨äºæ•°æ®è¯·æ±‚
- react-interactions  # ç”¨äºæµ‹è¯•äº¤äº’ç›¸å…³çš„å†…éƒ¨ç‰¹æ€§ï¼Œæ¯”å¦‚Reactçš„äº‹ä»¶æ¨¡å‹
- react-reconciler    # Reconcilerçš„å®ç°ï¼Œä½ å¯ä»¥ç”¨ä»–æ„å»ºè‡ªå·±çš„Renderer
```

```plain
- react-art
- react-dom                 # æ³¨æ„è¿™åŒæ—¶æ˜¯DOMå’ŒSSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰çš„å…¥å£
- react-native-renderer
- react-noop-renderer       # ç”¨äºdebug fiberï¼ˆåé¢ä¼šä»‹ç»fiberï¼‰
- react-test-renderer
```

### 
æˆ‘ä»¬éœ€è¦å…³æ³¨ä¸‰ä¸ªé‡ç‚¹çš„åœ°æ–¹ï¼šScheduler - Reconciler - Render;

 Reconciler æ˜¯æˆ‘ä»¬æ ¸å¿ƒçš„é‡ç‚¹ï¼Œå®ƒé“¾æ¥ä¸¤å¤´ï¼Œä¸€è¾¹æ˜¯Scheduler ä¸€è¾¹æ˜¯ Renderï¼ŒReactçš„æºç å¦‚ä½•è·å–ä»¥åŠå¦‚ä½•è¿›è¡Œæœ‰æ•ˆçš„è°ƒè¯•ï¼Ÿyarnçš„å‘½ä»¤æ“ä½œæœ‰å“ªäº›ï¼Ÿ

### å…³äºJSX
JSXä¼šè¢«é»˜è®¤ç¼–è¯‘æˆ React.createElement è°ƒç”¨

ClassComponent å’Œ FunctionComponent éƒ½æ˜¯ react comopnentï¼Œå¯¹ä»–ä»¬çš„instanceof Function = true éƒ½æ˜¯ä¸€æ ·çš„ç»“æ„ï¼ŒReact å†…éƒ¨ä½¿ç”¨ <font style="color:rgb(71, 101, 130);">isReactComponent æ¥åˆ¤æ–­ çœ‹çœ‹åˆ°åº•æ˜¯ä¸æ˜¯ classComponent</font>

**<font style="color:#DF2A3F;">JSX ä»…ä»…æ˜¯ä¸€ä¸ªæè¿°æ€§è´¨çš„æ•°æ®ç»“æ„ å¹¶ä¸åŒ…å« scheduler reconciler renderç›¸å…³çš„ä¿¡æ¯</font>**

[react/packages/react/src/ReactElement.js at 60a927d04ad3888facebcdf7da620aa1cfc9528f Â· facebook/react](https://github.com/facebook/react/blob/60a927d04ad3888facebcdf7da620aa1cfc9528f/packages/react/src/ReactElement.js#L362)

```javascript
export function createElement(type, config, children) {
}
- å‚æ•°1 å…·å¤‡çœŸå®DOM çš„type å«åšhostComponnetï¼Œ å¯¹äºClass ä¼ é€’çš„å°±æ˜¯Class
- å‚æ•°2 props
- å‚æ•°3 children


- React.createElement è¿™ä¸ªfuncionçš„æµç¨‹
{
  checkä¸€äº›é€šç”¨çš„config
  let propName;
  const props = {};

  let key = null;
  let ref = null;
  let self = null;
  let source = null;

  if (config != null) {
    if (hasValidRef(config)) {
      ref = config.ref;
      // ++++
    }
    if (hasValidKey(config)) {
      if (__DEV__) {
        checkKeyStringCoercion(config.key);
      }
      key = '' + config.key;
      // ++++
    }
    for (propName in config) {
      if (
        hasOwnProperty.call(config, propName) &&
        !RESERVED_PROPS.hasOwnProperty(propName)
      ) {
        props[propName] = config[propName];
      }
    }
  }
  // ++++

  // Resolve default props å¤„ç†ä¿ç•™å±æ€§
  if (type && type.defaultProps) {
    const defaultProps = type.defaultProps;
    for (propName in defaultProps) {
      if (props[propName] === undefined) {
        //å¤„ç†defalutProps
        props[propName] = defaultProps[propName];
      }
    }
  }
  if (__DEV__) {
    if (key || ref) {
      const displayName =
        typeof type === 'function'
          ? type.displayName || type.name || 'Unknown'
          : type;
      if (key) {
        defineKeyPropWarningGetter(props, displayName);
      }
      if (ref) {
        defineRefPropWarningGetter(props, displayName);
      }
    }
  }

  // æœ€ç»ˆè¿”å›ä¸€ä¸ª element è°ƒç”¨ è¿™ä¸ªè°ƒç”¨ä¼šè¿”å› ä¸€ä¸ªelementå¯¹è±¡ï¼Œ
  return ReactElement(
    type,
    key,
    ref,
    self,
    source,
    ReactCurrentOwner.current,
    props,
  );
}

function ReactElement(type, key, ref, self, source, owner, props) {
  const element = {
    // This tag allows us to uniquely identify this as a React Element
    $$typeof: REACT_ELEMENT_TYPE,

    // Built-in properties that belong on the element
    type: type,
    key: key,
    ref: ref,
    props: props,

    // Record the component responsible for creating this element.
    _owner: owner,
  };

  //++++++
  return element
}

å…³æ³¨ä¸€ä¸ªå±æ€§ "$$type === REACT_ELEMET_TYPE" çœ‹çœ‹æ˜¯ä¸æ˜¯åˆæ³•çš„rect elememt

```

é€šè¿‡ä¸€ä¸ªä¿®æ”¹çŸ¥ä¹ çš„æ‰€æœ‰dom ä¾‹å­ï¼Œæ¥ç†è§£createElememt ï¼Œè¯¦è§æ–‡ç« ï¼š

[ä¸€æ¬¡æ€§æ¸…é™¤â€œçŸ¥ä¹â€æ‰€æœ‰DIV](https://mp.weixin.qq.com/s?__biz=MzkzMjIxNTcyMA==&mid=2247485234&idx=1&sn=5962c47e3513e9cc4f6d8872df50bdbb&source=41#wechat_redirect)



Q&A:

ä»€ä¹ˆæ˜¯ï¼Ÿreact elemt functon (Elelemtè¿”å›å‡ºæ¥çš„ä¸œè¥¿ï¼‰

react Compoent æœ‰ä¸¤ç§ (Function /  Class)ï¼Œå®ƒä»¬éƒ½æ˜¯react componnet, componetä½œä¸ºcreateEletmçš„ç¬¬ä¸€ä¸ªå‚æ•°,jsx å’Œfiberçš„å…³ç³»ï¼š**<font style="color:#DF2A3F;">fiber ç»„ä»¶åˆ›å»ºçš„ä¾æ®å°±æ˜¯jsxæ•°æ®ç»“æ„ä¿¡æ¯ï¼Œfiberé€šè¿‡ function createFiberFomrElememntæ„å»º</font>**

# Renderé˜¶æ®µ
> è¿™é‡Œé‡‡å–çš„ç®—æ³•æ˜¯ ï¼šâ€œ**<font style="color:#DF2A3F;">æ·±åº¦ä¼˜å…ˆ</font>**â€
>

## æ•´ä½“çš„æµç¨‹å¤§æ¦‚çš„æ ·è²Œ
> æˆ‘ä»¬é€šè¿‡ è¿è¡Œä¸€ä¸ª reacté¡¹ç›®ï¼Œç„¶åä»chromeçš„jsæ‰§è¡Œå †æ ˆä¸­ å¯ä»¥æ¸…æ™°çš„çœ‹åˆ° ï¼Œreactçš„è¿è¡Œçš„é˜¶æ®µã€‚
>

åˆ›å»ºrootFiber

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705292732460-d460d451-5e67-429e-96ab-fed42af3da66.png)

æ‰§è¡Œä¸€ä¸‹render - schudelr ä¹Ÿåœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œ

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705292818021-6b041c4b-d308-4767-a91c-3165d4d3493a.png)

æ‰§è¡Œåç»­çš„comit

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705292862852-8855e87c-183b-4604-9a3f-7ad17292852c.png)



ä¸»è¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†çš„è°ƒç”¨æ ˆ

+ åˆ›å»ºåº”ç”¨æ ¹èŠ‚ç‚¹  åˆ›å»ºrootFiberé˜¶æ®µ
+ redneré˜¶æ®µ è°ƒåº¦å®Œä¹‹åå°±æ‰§è¡Œæ›´æ–°ï¼Œé€’å½’ä¸¤ä¸ªé˜¶æ®µ beginWork/CompoletWork 
+ comité˜¶æ®µï¼Œå®Œäº†ä¹‹å å°±æ˜¯comit  æ¸²æŸ“åˆ°pageä¸Š



## Fiber æ¶æ„
åœ¨React16 æ¶æ„ä¸­ è™šæ‹ŸDMO = Fiber ï¼Œå¼‚æ­¥çš„å¯ä¸­æ–­çš„æ›´æ–°ã€‚

React15 æ˜¯é€’å½’çš„åšæ³•å¯¼è‡´æ€§èƒ½ä¸è¶³ï¼›Fiberçš„ä¸‰å±‚å«ä¹‰ï¼ˆæ¶æ„ï¼Œé™æ€æ•°æ®ç»“æ„ï¼ŒåŠ¨æ€å·¥ä½œå•å…ƒï¼‰

Fiberçš„ç»“æ„å’Œå†…å®¹ (function FiberNode(){.....}) ä»¥åŠè¯¦ç»†çš„ä»‹ç»å’Œè¯´æ˜ï¼›

## åŒç¼“å­˜ç»“æ„
åˆ©ç”¨è¿™ç§æ•°æ®æ•°æ®ç»“æ„ æˆ‘ä»¬å¯ä»¥é«˜æ•ˆçš„æ›´æ–°DOMï¼›**<font style="color:rgb(44, 62, 80);">åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢</font>**<font style="color:rgb(44, 62, 80);">çš„æŠ€æœ¯å«åš</font>[åŒç¼“å­˜](https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2)<font style="color:rgb(44, 62, 80);">ï¼›åœ¨Reactä¸­çš„åŒç¼“å­˜Tree</font>

```javascript
currentFiber.alternate === workInProgressFiber;
workInProgressFiber.alternate === currentFiber;
```

React é€šè¿‡æ ¹èŠ‚(rootFiberNode)ç‚¹çš„CurrentæŒ‡é’ˆæŒ‡å‘ä¸åŒçš„ FiberTreeä¸Šçš„ rootFiber æ¥å®ŒæˆTreeçš„åˆ‡æ¢ï¼›	mountæ—¶ å’ŒUpdateçš„æ—¶å€™çš„åˆ‡æ¢è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿï¼›åœ¨æ›´æ–°Treeçš„è¿‡ç¨‹ä¸­ æˆ‘ä»¬æœ‰ä¸€ä¸ªç®—æ³• ä¼šå†³å®šæ˜¯å¦å¤ç”¨ æ²¡æœ‰å˜åŒ–çš„FiberNode ï¼Œè¿™ä¸ªç®—æ³•å°±æ˜¯ Reactçš„Diffç®—æ³•ï¼›

## æµç¨‹æ¢³ç†
FiberNode  å’Œ FiberTree å’Œæ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿå®ƒä»¬éƒ½æ˜¯åœ¨ Renderé˜¶æ®µçš„<font style="color:rgb(71, 101, 130);">performSyncWorkOnRootï¼ˆåŒæ­¥ï¼‰ å’ŒperformConcurrentWorkOnRoot(å¼‚æ­¥ æ–¹æ³• ä¸­åˆ›å»ºçš„å¹¶å®Œæˆè¿æ¥çš„ï¼Œæ¯”å¦‚ï¼›å…·ä½“çš„æµç¨‹æ˜¯ï¼š</font>

![ç”»æ¿](https://cdn.nlark.com/yuque/0/2024/jpeg/1627571/1704424680132-5338aac7-0d7a-4012-a234-a694ffe6e0d9.jpeg)

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ fiberç»“æ„å¦‚ä¸‹ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705298353352-69bd7eb8-7ec5-485d-b359-446567bb06c1.png)

render çš„æ‰§è¡Œè¿‡ç¨‹ ï¼ˆé‡ç‚¹Spanæ ‡ç­¾ç”±äºReactå†…éƒ¨ä¼˜åŒ–çš„åŸå› ï¼Œä¸ä¼šå¤„ç†å®ƒçš„å­èŠ‚ç‚¹çš„ (å½’é˜¶æ®µcompleteWork)ï¼Œåœ¨åªæœ‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„æ—¶å€™ ä¸ä¼šç”Ÿäº§fiber ä¸èµ°comleteWorkï¼‰ 

```typescript
1. rootFiber beginWork
2. App Fiber beginWork
3. div Fiber beginWork
4. "i am" Fiber beginWork
5. "i am" Fiber completeWork
6. span Fiber beginWork
7. span Fiber completeWork
8. div Fiber completeWork
9. App Fiber completeWork
10. rootFiber completeWork
```

## ä¸¤ä¸ªWork
è¿™é‡Œçš„ä¸¤ä¸ªWorkå°±æ˜¯æŒ‡ å‰é¢çš„æåˆ°çš„ beginWork å’Œ completeWorkï¼›

### beginWork
ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ï¼›ä¸¤ä¸ªåœºæ™¯çš„æµç¨‹mountå’Œupdateæ—¶ï¼›



mountæ—¶ æ¯æ¬¡beginWorkçš„ç»“æŸå®Œä¹‹åä¼šåˆ›å»ºä¸€ä¸ªFiberNode

```javascript
function beginWork(
  // ä¸Šæ¬¡çš„ fiber 
  current: Fiber | null,
  // å½“å‰ç»„ä»¶å¯¹åº”çš„FiberèŠ‚ç‚¹
  workInProgress: Fiber,
  // è°ƒåº¦ä¼˜å…ˆçº§ å…ˆä¸ç®¡
  renderLanes: Lanes,
): Fiber | null {
  // ç”±äºé¦–è¯„æ¸²æŸ“ æ²¡æœ‰ current æ‰€ä»¥ current === null ?æ¥åŒºåˆ†ç»„ä»¶æ˜¯å¤„äºmountè¿˜æ˜¯updateã€‚
 // updateæ—¶ï¼šå¦‚æœcurrentå­˜åœ¨å¯èƒ½å­˜åœ¨ä¼˜åŒ–è·¯å¾„ï¼Œå¯ä»¥å¤ç”¨currentï¼ˆå³ä¸Šä¸€æ¬¡æ›´æ–°çš„FiberèŠ‚ç‚¹ï¼‰
  if (current !== null) {
    // ...çœç•¥

    // å¤ç”¨current
    return bailoutOnAlreadyFinishedWork(
      current,
      workInProgress,
      renderLanes,
    );
  } else {
    didReceiveUpdate = false;
  }

  // mountæ—¶ï¼šæ ¹æ®tagä¸åŒï¼Œåˆ›å»ºä¸åŒçš„å­FiberèŠ‚ç‚¹
  switch (workInProgress.tag) {
    case IndeterminateComponent: 
      // ...çœç•¥
    case LazyComponent: 
      // ...çœç•¥
    case FunctionComponent: 
      // ...çœç•¥
    case ClassComponent: 
      // ...çœç•¥
    case HostRoot: //  // æ ¹ç»„ä»¶å°±æ˜¯è¿™ä¸ª 
      // ...çœç•¥
    case HostComponent:
      // ...çœç•¥
    case HostText:
      // ...çœç•¥
    // ...çœç•¥å…¶ä»–ç±»å‹
      // æœ€ç»ˆæˆ‘ä»¬ä¼šè¿›å…¥ reconcileChildren function
  }

}
```

reconcileChilderåšäº†äº›ä»€ä¹ˆï¼Ÿ åšä¸¤ä¸ªäº‹æƒ…

+ <font style="color:rgb(44, 62, 80);">å¯¹äº</font><font style="color:rgb(71, 101, 130);">mount</font><font style="color:rgb(44, 62, 80);">çš„ç»„ä»¶ï¼Œä»–ä¼šåˆ›å»ºæ–°çš„</font><font style="color:rgb(71, 101, 130);">å­FiberèŠ‚ç‚¹</font>
+ <font style="color:rgb(71, 101, 130);">uopdateçš„æ—¶å€™ æ‰§è¡Œdiffç®—æ³• å¯¹æ¯”fiber æŸ¥çœ‹å¤ç”¨</font>

```javascript
export function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes
) {
  if (current === null) {
    // å¯¹äºmountçš„ç»„ä»¶
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes,
    );
  } else {
    // å¯¹äºupdateçš„ç»„ä»¶
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes,
    );
  }
}
```

<font style="color:rgb(71, 101, 130);">renderé˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">çš„å·¥ä½œæ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œå½“å·¥ä½œç»“æŸåä¼šé€šçŸ¥</font><font style="color:rgb(71, 101, 130);">Renderer</font><font style="color:rgb(44, 62, 80);">éœ€è¦æ‰§è¡Œçš„</font><font style="color:rgb(71, 101, 130);">DOM</font><font style="color:rgb(44, 62, 80);">æ“ä½œã€‚è¦æ‰§è¡Œ</font><font style="color:rgb(71, 101, 130);">DOM</font><font style="color:rgb(44, 62, 80);">æ“ä½œçš„å…·ä½“ç±»å‹å°±ä¿å­˜åœ¨</font><font style="color:rgb(71, 101, 130);">fiber.effectTag</font><font style="color:rgb(44, 62, 80);">ä¸­ã€‚</font>

<font style="color:rgb(44, 62, 80);">effectTag è¡¨ç¤ºè¦æ‰§è¡Œçš„DOMæ“ä½œï¼›</font>

```javascript
// DOMéœ€è¦æ’å…¥åˆ°é¡µé¢ä¸­
export const Placement = /*                */ 0b00000000000010;
// DOMéœ€è¦æ›´æ–°
export const Update = /*                   */ 0b00000000000100;
// DOMéœ€è¦æ’å…¥åˆ°é¡µé¢ä¸­å¹¶æ›´æ–°
export const PlacementAndUpdate = /*       */ 0b00000000000110;
// DOMéœ€è¦åˆ é™¤
export const Deletion = /*                 */ 0b00000000001000;

// æ›´å¤šç±»å‹
```

<font style="color:rgb(44, 62, 80);">å…³äºeffectTag è¡¨ç¤ºè¦æŒ‡å‘æ’å…¥æ“ä½œ éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼š</font>

1. <font style="color:rgb(44, 62, 80);">fiber.stateNode  è¡¨ç¤º fiberä¸­ä¿å­˜äº†DOM </font>
2. <font style="color:rgb(44, 62, 80);">fiber.effectTag &= Placment != 0ï¼Œè¡¨ç¤º fiberèŠ‚ç‚¹å­˜åœ¨Placment EffectTag</font>

<font style="color:rgb(44, 62, 80);">mountæ—¶è™½ç„¶ stateNode   = null ï¼Œä½†æ˜¯ä¼šåœ¨completetWorkä¸­å¤„ç†å®Œæˆï¼Œå¯¹äºmountæ—¶ åªä¼šç»™rootFiberNode æ‰“ç®— Placemnet EffectTagå…¶å­fiber ä¸éœ€è¦åšæ’å…¥æ“ä½œã€‚</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">montæ—¶æ€»ç»“ï¼š</font>

<font style="color:rgb(44, 62, 80);">å½“æŸä¸€ä¸ªfibrè¿›å…¥beginWorkæ—¶è¦èµ°ä¸‹é¢çš„è·¯ç¨‹ï¼šæœ€ç»ˆçš„ç›®çš„ å°±æ˜¯åˆ›å»ºå½“å‰fiberèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­fiberèŠ‚ç‚¹ï¼Œ</font>

1. å…ˆåˆ¤æ–­fiberä¸åŒçš„ç±»å‹ è¿›è¡Œä¸åŒçš„updateé€»è¾‘
2. åˆ¤æ–­workInperrçœ‹çœ‹æ˜¯å¦éœ€è¦æ ‡è®°effctTag
3. è¿›å…¥recondileé€»è¾‘ï¼Œçœ‹çœ‹å½“å‰fiberçš„chileræ˜¯ä»€ä¹ˆç±»å‹ï¼Œå…·ä½“æ‰§è¡Œä»€ä¹ˆæ“ä½œ
4. æœ€ç»ˆåˆ›å»º ä¸€ä¸ªFiberè¿”å›



updateæ—¶çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

```javascript
// didReceiveUpdate === falseï¼ˆå³å¯ä»¥ç›´æ¥å¤ç”¨å‰ä¸€æ¬¡æ›´æ–°çš„å­Fiberï¼Œä¸éœ€è¦æ–°å»ºå­Fiberï¼‰
if (current !== null) {
    const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;

    if (
      oldProps !== newProps ||
      hasLegacyContextChanged() ||
      (__DEV__ ? workInProgress.type !== current.type : false)
    ) {
      // oldProps === newProps && workInProgress.type === current.typeï¼Œ
			// å³propsä¸fiber.typeä¸å˜
      
      didReceiveUpdate = true;
    } else if (!includesSomeLane(renderLanes, updateLanes)) {

      // !includesSomeLane(renderLanes, updateLanes)ï¼Œ
			// å³å½“å‰FiberèŠ‚ç‚¹ä¼˜å…ˆçº§ä¸å¤Ÿï¼Œä¼šåœ¨è®²è§£Scheduleræ—¶ä»‹ç»
      didReceiveUpdate = false;
      switch (workInProgress.tag) {
        // çœç•¥å¤„ç†
      }
      return bailoutOnAlreadyFinishedWork(
        current,
        workInProgress,
        renderLanes,
      );
    } else {
      didReceiveUpdate = false;
    }
  } else {
    didReceiveUpdate = false;
  }
```

å¯¹äºFunctionCompommet æ¥è¯´ ä¼šåœ¨å†…éƒ¨æ‰§è¡Œä¸€æ¬¡ è¿™ä¸ªFunction ï¼Œç„¶åè¿”å›è¿™ä¸ªjsxå¯¹è±¡ã€‚å†…éƒ¨è°ƒç”¨é“¾è·¯æ˜¯ renderWithHooks çš„è¿”å›å€¼ ä½œä¸º nexChildren ç„¶åç»§ç»­å‘ä¸‹ä¼ é€’ è¿›å…¥reconcileChildren 



![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704425201547-fa83dca6-7e4a-4ab1-8668-35802e2e676e.png)

### CompletWork
å’Œbeginworkç±»ä¼¼ï¼Œå¯¹ä¸åŒçš„fiber.tag åšä¸åŒçš„å¤„ç†ï¼›

é‡ç‚¹å…³æ³¨ä¸€ä¸‹æ¸²æŸ“å¿…é€‰çš„hostComponent(<font style="color:rgb(44, 62, 80);"> åŸç”Ÿ</font><font style="color:rgb(71, 101, 130);">DOMç»„ä»¶</font><font style="color:rgb(44, 62, 80);">å¯¹åº”çš„</font><font style="color:rgb(71, 101, 130);">Fiber Node </font>)è¿™ç§fiber.tag;

ä¹Ÿæ˜¯åˆ†ä¸¤ä¸ªé˜¶æ®µ updateæ—¶ å’Œ mountæ—¶ï¼›



<font style="color:rgb(44, 62, 80);">å½“</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(44, 62, 80);">æ—¶ï¼Œ</font><font style="color:rgb(71, 101, 130);">FiberèŠ‚ç‚¹</font><font style="color:rgb(44, 62, 80);">å·²ç»å­˜åœ¨å¯¹åº”</font><font style="color:rgb(71, 101, 130);">DOMèŠ‚ç‚¹</font><font style="color:rgb(44, 62, 80);">ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”Ÿæˆ</font><font style="color:rgb(71, 101, 130);">DOMèŠ‚ç‚¹</font><font style="color:rgb(44, 62, 80);">ã€‚éœ€è¦åšçš„ä¸»è¦æ˜¯å¤„ç†</font><font style="color:rgb(71, 101, 130);">props</font>

<font style="color:rgb(44, 62, 80);">ä»ä»£ç æ¥çœ‹ udateæˆ‘é‚£ä¹‹åçš„æœ€åè°ƒç”¨æ ˆä¼š è¢«å¤„ç†å®Œçš„</font><font style="color:rgb(71, 101, 130);">props</font><font style="color:rgb(44, 62, 80);">ä¼šè¢«èµ‹å€¼ç»™</font><font style="color:rgb(71, 101, 130);">workInProgress.updateQueue ç„¶ååœ¨åç»­çš„commié˜¶æ®µä½¿ç”¨åˆ°å®ƒ</font>

```javascript
if (current !== null && workInProgress.stateNode != null) {
  // updateçš„æƒ…å†µ
  updateHostComponent(
    current,
    workInProgress,
    type,
    newProps,
    rootContainerInstance,
  );
}
```

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">mount æ—¶ ä¸»è¦åšä¸‰ä¸ªäº‹æƒ…</font>

1. <font style="color:rgb(71, 101, 130);">ä¸ºFiberNode ç”Ÿæˆå¯¹äºçš„DOM</font>
2. <font style="color:rgb(71, 101, 130);">æŠŠå­å­™çš„DOMæ’å…¥åˆ° ç”Ÿæˆçš„DOMä¸­å»</font>
3. <font style="color:rgb(71, 101, 130);">å¤„ç†Porps ï¼ˆåŒupdateæ—¶çš„è¿‡ç¨‹ï¼‰</font>

<font style="color:rgb(71, 101, 130);">å‰æ–‡æåˆ°</font><font style="color:#DF2A3F;"> "å¯¹äºmountæ—¶ åªä¼šç»™rootFiberNode æ‰“ Placemnet EffectTagå…¶å­fiber ä¸éœ€è¦åšæ’å…¥æ“ä½œã€‚</font><font style="color:rgb(71, 101, 130);">"  å…¶rootFiberNode çš„å­ fiberå¯¹äºçš„DOMå¦‚ä½•è¿½åŠ çš„å‘¢ï¼Ÿç§˜å¯†å°±åœ¨componnetWorkè¿™é‡Œã€‚å®ƒä¼šè°ƒç”¨ä¸€ä¸ªappendAllChildrenï¼ŒæŠŠå­çš„fiberNodeä»¥åŠå…¶DOM è¿½åŠ åˆ°rootFiberNodeä¸Šå»ï¼ˆè¿™ä¸€æ­¥å®Œæˆä¹‹ åœ¨å†…å­˜ä¸­å°±ä¼šå­˜åœ¨ä¸€é¢—å®Œæ•´çš„dom treeäº†ï¼‰ï¼Œå½¢æˆä¸€é¢—å†…å­˜ä¸­çš„Tree(åŒ…æ‹¬DOMå’ŒFiberï¼‰ç„¶åä»–ä¼šåœ¨Commit é˜¶æ®µæ¸²æŸ“åˆ°é¡µé¢å»ï¼›</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">å…³äºeffectList, å‰æ–‡æåˆ° effectä¿å­˜äº† fiberNodeä¸Šçš„å°†è¦æ‰§è¡Œçš„ä½•ç§DOMæ“ä½œï¼Œå¦‚æœæ¯æ¬¡éå†è¿™é¢—å¤§çš„FiberNodeTreeæ€§èƒ½æ˜¯ä¸å¥½çš„ï¼Œåœ¨Reactä¸­ æˆ‘ä»¬ä¼šæŠŠæ‰€æœ‰æ¶‰åŠåˆ°çš„effectä¿å­˜æˆä¸€æ¡å•å‘é“¾è¡¨ï¼Œéå†å®ƒä»¥å®Œæˆå„ç§effectæ“ä½œ</font>

```javascript
rootFiber.firstEffect -----------> fiber -----------> fiber
```

èµ°å®Œä¸Šé¢çš„æµç¨‹ ï¼Œä¿¡æ¯é½å…¨çš„åŒç¼“å­˜FiberTreeå°±å‡†å¤‡å¥½äº†ï¼Œæ¥ä¸‹é‡Œå°±æ˜¯äº¤ç»™ commitå»æ¸²æŸ“äº†

```javascript
commitRoot(root)
```

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704427082806-a3023027-694f-4889-aaf2-32b5c882844b.png)

# Commité˜¶æ®µ
> ç”Ÿå‘½å‘¨æœŸå•Š hooks effectå•Š props çš„å˜åŒ– ï¼Œéƒ½åœ¨è¿™ä¸ªé˜¶æ®µå¤„ç†
>

commité˜¶æ®µçš„å¤„ç†åˆ†ä¸‰ä¸ªéƒ¨åˆ†(mutation çš„å‰ä¸­å)

before mutaion domæ“ä½œå‰ï¼›mutation domæ“ä½œä¸­ï¼›layout dom æ“ä½œåï¼›

commitRootæ–¹æ³•æ˜¯comité˜¶æ®µçš„å…¥å£ï¼Œä¼ é€’çš„å‚æ•°æ˜¯fiberRootNodeï¼Œå®ƒä¸Šé¢ä¼šä¿å­˜ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ fiberèŠ‚ç‚¹æ„å»ºçš„å½“å‘é“¾è¡¨effectListï¼Œè¿™äº›fiberä¸Šçš„updateQueueä¸­ä¿å­˜äº† å˜åŒ–çš„porps

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»£ç 

before mutaion å‰

```typescript
do {
    // è§¦å‘useEffectå›è°ƒä¸å…¶ä»–åŒæ­¥ä»»åŠ¡ã€‚ç”±äºè¿™äº›ä»»åŠ¡å¯èƒ½è§¦å‘æ–°çš„æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œè¦ä¸€ç›´éå†æ‰§è¡Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡
    flushPassiveEffects();
  } while (rootWithPendingPassiveEffects !== null);

  // rootæŒ‡ fiberRootNode
  // root.finishedWorkæŒ‡å½“å‰åº”ç”¨çš„rootFiber
  const finishedWork = root.finishedWork;

  // å‡¡æ˜¯å˜é‡åå¸¦laneçš„éƒ½æ˜¯ä¼˜å…ˆçº§ç›¸å…³
  const lanes = root.finishedLanes;
  if (finishedWork === null) {
    return null;
  }
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // é‡ç½®Schedulerç»‘å®šçš„å›è°ƒå‡½æ•°
  root.callbackNode = null;
  root.callbackId = NoLanes;

  let remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);
  // é‡ç½®ä¼˜å…ˆçº§ç›¸å…³å˜é‡
  markRootFinished(root, remainingLanes);

  // æ¸…é™¤å·²å®Œæˆçš„discrete updatesï¼Œä¾‹å¦‚ï¼šç”¨æˆ·é¼ æ ‡ç‚¹å‡»è§¦å‘çš„æ›´æ–°ã€‚
  if (rootsWithPendingDiscreteUpdates !== null) {
    if (
      !hasDiscreteLanes(remainingLanes) &&
      rootsWithPendingDiscreteUpdates.has(root)
    ) {
      rootsWithPendingDiscreteUpdates.delete(root);
    }
  }

  // é‡ç½®å…¨å±€å˜é‡
  if (root === workInProgressRoot) {
    workInProgressRoot = null;
    workInProgress = null;
    workInProgressRootRenderLanes = NoLanes;
  } else {
  }

  // å°†effectListèµ‹å€¼ç»™firstEffect
  // ç”±äºæ¯ä¸ªfiberçš„effectListåªåŒ…å«ä»–çš„å­å­™èŠ‚ç‚¹
  // æ‰€ä»¥æ ¹èŠ‚ç‚¹å¦‚æœæœ‰effectTagåˆ™ä¸ä¼šè¢«åŒ…å«è¿›æ¥
  // æ‰€ä»¥è¿™é‡Œå°†æœ‰effectTagçš„æ ¹èŠ‚ç‚¹æ’å…¥åˆ°effectListå°¾éƒ¨
  // è¿™æ ·æ‰èƒ½ä¿è¯æœ‰effectçš„fiberéƒ½åœ¨effectListä¸­
  let firstEffect;
  if (finishedWork.effectTag > PerformedWork) {
    if (finishedWork.lastEffect !== null) {
      finishedWork.lastEffect.nextEffect = finishedWork;
      firstEffect = finishedWork.firstEffect;
    } else {
      firstEffect = finishedWork;
    }
  } else {
    // æ ¹èŠ‚ç‚¹æ²¡æœ‰effectTag
    firstEffect = finishedWork.firstEffect;
  }`
```

mutaion  å

```typescript
const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;

// useEffectç›¸å…³
if (rootDoesHavePassiveEffects) {
  rootDoesHavePassiveEffects = false;
  rootWithPendingPassiveEffects = root;
  pendingPassiveEffectsLanes = lanes;
  pendingPassiveEffectsRenderPriority = renderPriorityLevel;
} else {}

// æ€§èƒ½ä¼˜åŒ–ç›¸å…³
if (remainingLanes !== NoLanes) {
  if (enableSchedulerTracing) {
    // ...
  }
} else {
  // ...
}

// æ€§èƒ½ä¼˜åŒ–ç›¸å…³
if (enableSchedulerTracing) {
  if (!rootDidHavePassiveEffects) {
    // ...
  }
}

// ...æ£€æµ‹æ— é™å¾ªç¯çš„åŒæ­¥ä»»åŠ¡
if (remainingLanes === SyncLane) {
  // ...
} 

// åœ¨ç¦»å¼€commitRootå‡½æ•°å‰è°ƒç”¨ï¼Œè§¦å‘ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œç¡®ä¿ä»»ä½•é™„åŠ çš„ä»»åŠ¡è¢«è°ƒåº¦
ensureRootIsScheduled(root, now());

// ...å¤„ç†æœªæ•è·é”™è¯¯åŠè€ç‰ˆæœ¬é—ç•™çš„è¾¹ç•Œé—®é¢˜


// æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œè¿™æ ·åŒæ­¥ä»»åŠ¡ä¸éœ€è¦ç­‰åˆ°ä¸‹æ¬¡äº‹ä»¶å¾ªç¯å†æ‰§è¡Œ
// æ¯”å¦‚åœ¨ componentDidMount ä¸­æ‰§è¡Œ setState åˆ›å»ºçš„æ›´æ–°ä¼šåœ¨è¿™é‡Œè¢«åŒæ­¥æ‰§è¡Œ
// æˆ–useLayoutEffect
flushSyncCallbackQueue();

return null;
```

### before mutation 
æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éå†effectList å¹¶æ‰§è¡Œ <font style="color:rgb(71, 101, 130);">commitBeforeMutationEffects ï¼Œä¼ é€’çš„æ˜¯ finishWorkï¼ˆï¼‰ï¼ŒcommitBeforeMuationEffects æºç å¦‚ä¸‹</font>

```typescript
function commitBeforeMutationEffects() {
  while (nextEffect !== null) {
    const current = nextEffect.alternate;

    if (!shouldFireAfterActiveInstanceBlur && focusedInstanceHandle !== null) {
      // ...focus blurç›¸å…³
    }

    const effectTag = nextEffect.effectTag;

    // è°ƒç”¨getSnapshotBeforeUpdate
    if ((effectTag & Snapshot) !== NoEffect) {
      commitBeforeMutationEffectOnFiber(current, nextEffect);
    }

    // è°ƒåº¦useEffect
    if ((effectTag & Passive) !== NoEffect) {
      if (!rootDoesHavePassiveEffects) {
        rootDoesHavePassiveEffects = true;
        scheduleCallback(NormalSchedulerPriority, () => {
          flushPassiveEffects();
          return null;
        });
      }
    }
    nextEffect = nextEffect.nextEffect;
  }
}
```

è§‚å¯Ÿåˆ°å®ƒåšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š

1. å¤„ç†DOM æ¸²æŸ“å‰åçš„autoFocusï¼Œbluré€»è¾‘
2. è°ƒç”¨<font style="color:rgb(71, 101, 130);">getSnapshotBeforeUpdate</font>
3. <font style="color:rgb(71, 101, 130);">è°ƒåº¦useEffect</font>

<font style="color:rgb(71, 101, 130);"></font>

è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ<font style="color:rgb(71, 101, 130);">getSnapshotBeforeUpdateï¼ˆè¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†åº”å¯¹15 -> Fiber çš„å‡çº§è¿‡ç¨‹ä¸­ï¼Œç”±äº fiberä¸ºå¯ä¸­æ–­çš„æ›´æ–°ï¼Œä¸ºé¿å…å¤šæ¬¡è°ƒç”¨componentWillXXXï¼Œè€Œè®¾è®¡çš„ä¸€ä¸ª ç”Ÿå‘½å‘¨æœŸfunctionï¼‰ã€‚æ³¨æ„comité˜¶æ®µæ˜¯åŒæ­¥çš„ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸä¸ä¼šé‡åˆ°å¤šæ¬¡è°ƒåº¦çš„é—®é¢˜ã€‚è¿™ä¸ªç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨çš„å…¥å£åœ¨ commitBeforeMutationEffectOnFiber ä¸­ï¼Œå®ƒä¼šå–åˆ°å½“å‰ClassCompometçš„instan ä¸Šç„¶ååˆ¤æ–­æ˜¯å¦å«æœ‰ è¿™ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå¦‚æœæœ‰å°±ä¼šè°ƒç”¨</font>

[<font style="color:rgb(71, 101, 130);">https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L222</font>](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L222)

```javascript
function commitBeforeMutationLifeCycles(
  current: Fiber | null,
  finishedWork: Fiber,
): void {
  switch (finishedWork.tag) {
    case FunctionComponent:
    case ForwardRef:
    case SimpleMemoComponent:
    case Block: {
      return;
    }
   case ClassComponent: {
     // ++++++
  		if (finishedWork.effectTag & Snapshot) {
						const snapshot = instance.getSnapshotBeforeUpdate(
            finishedWork.elementType === finishedWork.type
              ? prevProps
              : resolveDefaultProps(finishedWork.type, prevProps),
            prevState,
          );
// +++++
  }
```

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">useEffect çš„è°ƒåº¦æˆ–è®¸æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è°ƒåº¦è¿‡ç¨‹ï¼Œè§¦å‘çš„æ˜¯useEffectçš„flushPassiveEffects functionï¼Œ</font>

```javascript
// å­˜åœ¨useEffectï¼Œè°ƒåº¦ä»–
if ((effectTag & Passive) !== NoEffect) {
  if (!rootDoesHavePassiveEffects) {
    rootDoesHavePassiveEffects = true;
    // è°ƒåº¦å™¨ scheduleCallbackæ˜¯ å¦ä¸€ä¸ªæ¨¡å—çš„äº‹æƒ…
    scheduleCallback(NormalSchedulerPriority, () => {
      // è§¦å‘useEffect
      flushPassiveEffects();
      return null;
    });
  }
}
```

<font style="color:rgb(71, 101, 130);">flushPassiveEffects å…·ä½“çš„æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</font>

<font style="color:rgb(71, 101, 130);">å®ƒä»å…¨å±€å˜é‡ rootWithPendingPassiveEffects è·å–effectList (è¿™é‡Œé¢åŒ…æ‹¬æ‰€æœ‰äº†å‰¯ä½œç”¨æ“ä½œåŒ…æ‹¬useEffect..., æ€»è€Œè¨€ä¹‹ effectTagçš„ç±»å‹æœ‰å¾ˆå¤šå“ˆï¼‰ç„¶åéå†è¿™ä¸ªlist å¹¶ä¸”æ‰§è¡Œeffectçš„å›è°ƒï¼ŒrootWithPendingPassiveEffects çš„å…·ä½“èµ‹å€¼æ“ä½œåœ¨Layotuä¸­è¿›è¡Œã€‚</font>

```typescript
const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;
// è¿™ä¸ªæ¡ä»¶ å†³å®šäº† æ˜¯å¦ç»™ rootWithPendingPassiveEffects èµ‹å€¼
if (rootDoesHavePassiveEffects) {
  rootDoesHavePassiveEffects = false;
  rootWithPendingPassiveEffects = root;
  pendingPassiveEffectsLanes = lanes;
  pendingPassiveEffectsRenderPriority = renderPriorityLevel;
}
```

<font style="color:rgb(71, 101, 130);">æ•…è€Œ æ€»ä½“æµç¨‹æ˜¯ï¼š</font>

1. <font style="color:rgb(71, 101, 130);">before mutationé˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">åœ¨</font><font style="color:rgb(71, 101, 130);">scheduleCallback</font><font style="color:rgb(44, 62, 80);">ä¸­è°ƒåº¦</font><font style="color:rgb(71, 101, 130);">flushPassiveEffects</font>
2. <font style="color:rgb(71, 101, 130);">layouté˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">ä¹‹åå°†</font><font style="color:rgb(71, 101, 130);">effectList</font><font style="color:rgb(44, 62, 80);">èµ‹å€¼ç»™</font><font style="color:rgb(71, 101, 130);">rootWithPendingPassiveEffects</font>
3. <font style="color:rgb(71, 101, 130);">scheduleCallback</font><font style="color:rgb(44, 62, 80);">è§¦å‘</font><font style="color:rgb(71, 101, 130);">flushPassiveEffects</font><font style="color:rgb(44, 62, 80);">ï¼Œ</font><font style="color:rgb(71, 101, 130);">flushPassiveEffects</font><font style="color:rgb(44, 62, 80);">å†…éƒ¨éå†</font><font style="color:rgb(71, 101, 130);">rootWithPendingPassiveEffects</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">å¼‚æ­¥çš„è°ƒç”¨ </font><font style="color:rgb(153, 153, 153);">ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ </font>

é¢˜å¤–è¯ï¼šæ¨èä¸€ä¸ªvsCodeæ’ä»¶bookmarkï¼Œä»–å¯ä»¥è®©ä½ åœ¨ä»£ç çš„æŸå¤„æ‰“ä¸€ä¸ªæ ‡ç­¾ğŸ·ï¸ï¼Œå¯¹é˜…è¯»æºä»£å¤§é‡ä»£ç æœ‰å¸®åŠ©

### mutation
è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯ éå†  <font style="color:rgb(71, 101, 130);">effectList</font>ï¼Œ å…·ä½“çš„æ‰§è¡Œåœ¨ commitMutaionEffectsä¸­ã€‚å¯¹æ¯ä¸ªfiberNodeæ‰§è¡Œä¸‹é¢çš„æ“ä½œ

```javascript
function commitMutationEffects(root: FiberRoot, renderPriorityLevel) {
  // éå†effectList
  while (nextEffect !== null) {

    const effectTag = nextEffect.effectTag;

    // æ ¹æ® ContentReset effectTagé‡ç½®æ–‡å­—èŠ‚ç‚¹
    if (effectTag & ContentReset) {
      commitResetTextContent(nextEffect);
    }

    // æ›´æ–°ref
    if (effectTag & Ref) {
      const current = nextEffect.alternate;
      if (current !== null) {
        commitDetachRef(current);
      }
    }

    // æ ¹æ® effectTag åˆ†åˆ«å¤„ç†
    const primaryEffectTag =
      effectTag & (Placement | Update | Deletion | Hydrating);
    switch (primaryEffectTag) {
      // æ’å…¥DOM
      case Placement: {
        commitPlacement(nextEffect);
        nextEffect.effectTag &= ~Placement;
        break;
      }
      // æ’å…¥DOM å¹¶ æ›´æ–°DOM
      case PlacementAndUpdate: {
        // æ’å…¥
        commitPlacement(nextEffect);

        nextEffect.effectTag &= ~Placement;

        // æ›´æ–°
        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // SSR
      case Hydrating: {
        nextEffect.effectTag &= ~Hydrating;
        break;
      }
      // SSR
      case HydratingAndUpdate: {
        nextEffect.effectTag &= ~Hydrating;

        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // æ›´æ–°DOM
      case Update: {
        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // åˆ é™¤DOM
      case Deletion: {
        commitDeletion(root, nextEffect, renderPriorityLevel);
        break;
      }
    }

    nextEffect = nextEffect.nextEffect;
  }
}

```

1. é‡ç½®æ–‡æœ¬èŠ‚ç‚¹
2. æ›´æ–°ref
3. åˆ†åˆ«å¤„ç†ä¸åŒçš„effectTag ï¼ˆé‡ç‚¹å…³æ³¨ Placment Tagï¼Œupdate Tagï¼Œdeletion Tagï¼‰

åˆ†åˆ«çœ‹çœ‹åŒæ­¥çš„effectTag å…·ä½“å¹²äº†äº›å•¥ï¼Œ

<font style="color:rgb(71, 101, 130);">Placement tag , commitPlacement æ˜¯å¤„ç† DOMæ’å…¥çš„</font>ï¼Œè¿™éœ€è¦è·å–å®ƒæ˜¯æ‰€æœ‰çš„ çˆ¶äº²å…„å¼ŸDOMï¼Œç„¶åæ‰§è¡Œ<font style="color:rgb(71, 101, 130);">insertBefore æˆ–è€… appendChild,(æ³¨æ„DOMçš„èŠ‚ç‚¹å±‚çº§å’Œfiberçš„å±‚çº§ å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„å“ˆ)</font>

```javascript
// 1.è·å–çˆ¶äº²DOM
const parentFiber = getHostParentFiber(finishedWork);
// çˆ¶çº§DOMèŠ‚ç‚¹
const parentStateNode = parentFiber.stateNode;

// 2.è·å–fibeçš„å…„å¼Ÿdom
const before = getHostSibling(finishedWork);

// 3. çœ‹çœ‹æ˜¯å¦å†³å®šæ’å…¥æ“ä½œ
// parentStateNodeæ˜¯å¦æ˜¯rootFiber
if (isContainer) {
  insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);
} else {
  insertOrAppendPlacementNode(finishedWork, before, parent);
}
```

å¦‚æœé‡åˆ° update effectTag è¿™æ„å‘³ï¼Œè¿™ä¸ªFiber éœ€è¦æ›´æ–° ï¼Œä¸»è¦å…³æ³¨ ä¸¤ä¸ªä¸åŒåœºæ™¯çš„å¤„ç†<font style="color:rgb(71, 101, 130);">FunctionComponent</font><font style="color:rgb(44, 62, 80);">å’Œ</font><font style="color:rgb(71, 101, 130);">HostComponen</font>ï¼Œ

FunctionComponent è°ƒç”¨<font style="color:rgb(71, 101, 130);">commitHookEffectListUnmount</font>ï¼Œéå†effectList æ‰§è¡Œ useLayoutEffectçš„é”€æ¯å‡½æ•°(å°±æ˜¯runteré‚£ä¸ª function)æ“ä½œã€‚

hostComponent ä¼šè°ƒç”¨<font style="color:rgb(71, 101, 130);">commitUpdate</font>ï¼Œå§compoWorkä¸­fiberNode èµ‹å€¼<font style="color:rgb(71, 101, 130);">updateQueue</font>çš„å†…å®¹æ¸²æŸ“åˆ°é¡µé¢ä¸Š

```javascript
for (let i = 0; i < updatePayload.length; i += 2) {
  const propKey = updatePayload[i];
  const propValue = updatePayload[i + 1];

  // å¤„ç† style
  if (propKey === STYLE) {
    setValueForStyles(domElement, propValue);
  // å¤„ç† DANGEROUSLY_SET_INNER_HTML
  } else if (propKey === DANGEROUSLY_SET_INNER_HTML) {
    setInnerHTML(domElement, propValue);
  // å¤„ç† children
  } else if (propKey === CHILDREN) {
    setTextContent(domElement, propValue);
  } else {
  // å¤„ç†å‰©ä½™ props
    setValueForProperty(domElement, propKey, propValue, isCustomComponentTag);
  }
}
```

Deletion effectTag æ„å‘³ç€åˆ é™¤å†…å®¹ã€‚å°†è°ƒç”¨ <font style="color:rgb(71, 101, 130);">commitDeletionï¼Œä¸»è¦åšä¸‹é¢çš„äº‹æƒ…ï¼Œ</font>

<font style="color:rgb(71, 101, 130);">æºä»£ç è¯·è®¿é—® </font>[commitDeletionæºä»£ç ](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421)

1. <font style="color:rgb(71, 101, 130);">é€’å½’å¤„ç†æ‰€æœ‰çš„fiberå¯¹åº”çš„componentWillUnmountï¼Œç§»é™¤DOM</font>
2. <font style="color:rgb(71, 101, 130);">è§£é™¤ref</font>
3. <font style="color:rgb(71, 101, 130);">è°ƒç”¨æ‰€æœ‰çš„ useEffectçš„é”€æ¯function</font>

### <font style="color:rgb(71, 101, 130);">Layout</font>
è¿™ä¸ªé˜¶æ®µæ˜¯æ‰€æœ‰DOM ä¿®æ”¹å®Œä¹‹åçš„æ‰§è¡Œçš„ç”±äºJSçš„å µå¡ æ‰€æœ‰æµè§ˆå™¨è¿˜æ²¡æœ‰å®Œæˆæ¸²æŸ“å“ˆï¼ã€‚åŒæ ·çš„ä¹Ÿæ˜¯éå† effectList è°ƒç”¨çš„æ˜¯<font style="color:rgb(71, 101, 130);">commitLayoutEffectsã€‚</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">commitLayoutEffect ä¸»è¦çš„å·¥ä½œæ˜¯ </font>

1. <font style="color:rgb(44, 62, 80);">commitLayoutEffectOnFiber ç”Ÿå‘½å‘¨æœŸé’©å­è°ƒç”¨ + hooks</font>
2. <font style="color:rgb(44, 62, 80);">èµ‹å€¼ref commitAttachRef</font>

<font style="color:rgb(44, 62, 80);">å…·ä½“æ¥è¯´ï¼ŒcommitLayoutEffectOnFiber(</font><font style="color:rgb(71, 101, 130);">commitLifeCycles</font><font style="color:rgb(44, 62, 80);">) åšäº†ä¸‹é¢çš„äº‹æƒ…</font>

1. <font style="color:rgb(44, 62, 80);">å¯¹äºClassComponent ä¾æ®</font><font style="color:rgb(71, 101, 130);">current  æ˜¯å¦æœ‰å€¼ï¼Œçœ‹çœ‹æ˜¯mount /updateï¼Œåˆ†åˆ«è°ƒç”¨ DitMout/DitUpdateã€‚è‹¥æ˜¯FunctionCompnentä¸­æ˜¯setStateæœ‰å›è°ƒçš„ç”»ï¼Œä¹Ÿä¼šåœ¨æ­¤è°ƒç”¨</font>
2. <font style="color:rgb(71, 101, 130);">å¯¹äºFunctionComponent ä¼šè°ƒç”¨  useLayoutEffectï¼ˆä½ å¯ä»¥å‘ç° å®ƒçš„ä¸Šæ¬¡æ›´æ–°çš„è°ƒå› å’Œæœ¬æ¬¡æ›´æ–°çš„å›è°ƒæ˜¯åŒæ­¥è¿›è¡Œçš„) è€ŒuseEffect éœ€è¦å…ˆåœ¨scheduleä¸­è°ƒåº¦ï¼Œç„¶åå†commitä¸­è¿›è¡Œ å›è°ƒ è¿™æ˜¯å¼‚æ­¥çš„ã€‚</font>
3. <font style="color:rgb(71, 101, 130);">å¯¹äºHostRoot å®ƒä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œ ç¬¬ä¸‰ä¸ªcb å›è°ƒ</font>

```javascript
ReactDOM.render(<App />, document.querySelector("#root"),
  function() { // ç¬¬ä¸‰ä¸ªå‚æ•° å›è°ƒ
  console.log("i am mount~");
});
```

<font style="color:rgb(44, 62, 80);"></font>

å¯¹äº <font style="color:rgb(71, 101, 130);">commitAttachRef å°±ç®€å•è®¸å¤šäº†ã€‚åšä¸¤ä»¶äº‹ï¼šè·å–DOMå®ä¾‹ï¼Œæ›´æ–°Ref</font>

<font style="color:rgb(71, 101, 130);">è‡³æ­¤ layouté˜¶æ®µå°±ç»“æŸäº†ã€‚</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">åœ¨Mutation é˜¶æ®µç»“æŸå Layoutå¼€å§‹å‰æ‰§è¡Œã€‚ root.current = finshiWork å®ŒæˆåŒç¼“å­˜æ•°çš„åˆ‡æ¢ï¼ˆ</font><font style="color:rgb(44, 62, 80);">è¿™è¡Œä»£ç çš„ä½œç”¨å°±æ˜¯åˆ‡æ¢</font><font style="color:rgb(71, 101, 130);">rootFiberNode</font><font style="color:rgb(44, 62, 80);">æŒ‡å‘çš„</font><font style="color:rgb(71, 101, 130);">current Fiberæ ‘</font><font style="color:rgb(44, 62, 80);">ã€‚</font><font style="color:rgb(71, 101, 130);">ï¼‰ </font><font style="color:#DF2A3F;">å› ä¸ºcomponentWillUnmount ä¼šåœ¨mutation é˜¶æ®µæ‰§è¡Œ</font><font style="color:rgb(71, 101, 130);">ï¼Œæ­¤æ—¶ fiber treeè¿˜æ²¡æœ‰åˆ‡ï¼Œåˆ°äº†Layout ä¼šæ‰§è¡Œ DidMount / DitUpdate è¿™ä¸ªæ—¶å€™éœ€è¦è·å–æœ€æ–°çš„fiber treeï¼Œæ‰€ä»¥åˆ‡æ¢çš„æ“åšæ˜¯å¤¹åœ¨ä¸¤ä¸ªé˜¶æ®µä¹‹é—´å®Œæˆçš„ã€‚</font>

<font style="color:rgb(71, 101, 130);"></font>

å¯¹æ¯”ä¸¤ä¸ªuseEffect & useLayoutEffect

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705393246436-60aa0eea-8fbd-4786-892b-546a94b4f4fe.png)

# Diffç®—æ³•
è¿™é‡Œçš„diffç®—æ³•æ˜¯æŒ‡åœ¨ å‰é¢æåˆ°çš„beginWorkä¸­çš„updateæ—¶çš„ fiberèŠ‚ç‚¹å¯¹æ¯”å¤ç”¨çš„å…·ä½“å®ç°ã€‚

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704505351955-98dad1cc-43bf-46d8-873e-14c23f62c5a8.png)

å¤§é‡çš„TreeèŠ‚ç‚¹çš„å¯¹æ¯”å’Œdiffå¾€å¾€æ€§èƒ½å¾ˆçƒ‚ï¼Œå› æ­¤ reactä¼˜åŒ–äº†è¿™ç±»çš„ç®—æ³•

1. åªå¯¹åŒçº§å…ƒç´ è¿›è¡Œdiff å¦‚æœè·¨å±‚çº§äº†å°±ä¸æ‰“ç®— å¤ç”¨
2. å¦‚æœä¸¤æ¬¡å¯¹æ¯”ä¸­ å‘ç°æ˜¯ä¸ä¸€æ ·çš„ å…ƒç´ ç±»å‹ ç›´æ¥ä¸å¤ç”¨
3. å¼€å‘è€… å¯ä»¥é€šè¿‡key æ¥æŒ‡å®š è¦ä¸è¦å¤ç”¨

ç®—æ³•æ˜¯å…¥å£æ˜¯åœ¨ <font style="color:rgb(71, 101, 130);">reconcileChildFibers è¿™ä¸ªfunction ä¸­ï¼Œå®ƒä¾æ®ä¼ å…¥çš„newChildï¼ˆJSXå¯¹è±¡ï¼‰ ç±»å‹æ¥åšä¸åŒçš„å¤„ç†ï¼Œè‹¥ä¸ºobject number string é‚£ä¹ˆå°±æ˜¯è¡¨ç¤ºåŒçº§åªè¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯Arrayè¯´æ˜æ˜¯åŒ…å« åŒå±‚çº§åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼Œ</font>

<font style="color:rgb(71, 101, 130);">äºæ˜¯æˆ‘ä»¬å°±æœ‰ä¸¤ç§ä¸åŒçš„å¤„ç†åœºæ™¯</font>

```typescript
// æ ¹æ®newChildç±»å‹é€‰æ‹©ä¸åŒdiffå‡½æ•°å¤„ç†
function reconcileChildFibers(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChild: any,
): Fiber | null {

  const isObject = typeof newChild === 'object' && newChild !== null;

  if (isObject) {
    // objectç±»å‹ï¼Œå¯èƒ½æ˜¯ REACT_ELEMENT_TYPE æˆ– REACT_PORTAL_TYPE
    switch (newChild.$$typeof) {
      case REACT_ELEMENT_TYPE:
        // è°ƒç”¨ reconcileSingleElement å¤„ç†
      // // ...çœç•¥å…¶ä»–case
    }
  }

  if (typeof newChild === 'string' || typeof newChild === 'number') {
    // è°ƒç”¨ reconcileSingleTextNode å¤„ç†
    // ...çœç•¥
  }

  if (isArray(newChild)) {
    // è°ƒç”¨ reconcileChildrenArray å¤„ç†
    // ...çœç•¥
  }

  // ä¸€äº›å…¶ä»–æƒ…å†µè°ƒç”¨å¤„ç†å‡½æ•°
  // ...çœç•¥

  // ä»¥ä¸Šéƒ½æ²¡æœ‰å‘½ä¸­ï¼Œåˆ é™¤èŠ‚ç‚¹
  return deleteRemainingChildren(returnFiber, currentFirstChild);
}
```

### <font style="color:rgb(71, 101, 130);">å•èŠ‚ç‚¹Diff</font>
![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704505972017-d55ae19d-a3d8-4198-a4c5-5affd6175157.png)

å…³äºæ˜¯å¦å¤ç”¨çš„é€»è¾‘åœ¨ <font style="color:rgb(71, 101, 130);">reconcileSingleElement</font> functionä¸­

+ <font style="color:rgb(44, 62, 80);">å½“</font><font style="color:rgb(71, 101, 130);">child !== null</font><font style="color:rgb(44, 62, 80);">ä¸”</font><font style="color:rgb(71, 101, 130);">keyç›¸åŒ</font><font style="color:rgb(44, 62, 80);">ä¸”</font><font style="color:rgb(71, 101, 130);">typeä¸åŒ</font><font style="color:rgb(44, 62, 80);">æ—¶æ‰§è¡Œ</font><font style="color:rgb(71, 101, 130);">deleteRemainingChildren</font><font style="color:rgb(44, 62, 80);">å°†</font><font style="color:rgb(71, 101, 130);">child</font><font style="color:rgb(44, 62, 80);">åŠå…¶å…„å¼Ÿ</font><font style="color:rgb(71, 101, 130);">fiber</font><font style="color:rgb(44, 62, 80);">éƒ½æ ‡è®°åˆ é™¤ã€‚</font>
+ <font style="color:rgb(44, 62, 80);">å½“</font><font style="color:rgb(71, 101, 130);">child !== null</font><font style="color:rgb(44, 62, 80);">ä¸”</font><font style="color:rgb(71, 101, 130);">keyä¸åŒ</font><font style="color:rgb(44, 62, 80);">æ—¶ä»…å°†</font><font style="color:rgb(71, 101, 130);">child</font><font style="color:rgb(44, 62, 80);">æ ‡è®°åˆ é™¤ã€‚</font>

<font style="color:rgb(44, 62, 80);">å…¶æºä»£ç é•¿è¿™æ ·</font>

```javascript
function reconcileSingleElement(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  element: ReactElement
): Fiber {
  const key = element.key;
  let child = currentFirstChild;
  
  // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”DOMèŠ‚ç‚¹
  while (child !== null) {
    // ä¸Šä¸€æ¬¡æ›´æ–°å­˜åœ¨DOMèŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å¯å¤ç”¨

    // é¦–å…ˆæ¯”è¾ƒkeyæ˜¯å¦ç›¸åŒ
    if (child.key === key) {

      // keyç›¸åŒï¼Œæ¥ä¸‹æ¥æ¯”è¾ƒtypeæ˜¯å¦ç›¸åŒ

      switch (child.tag) {
        // ...çœç•¥case
        
        default: {
          if (child.elementType === element.type) {
            // typeç›¸åŒåˆ™è¡¨ç¤ºå¯ä»¥å¤ç”¨
            // è¿”å›å¤ç”¨çš„fiber
            return existing;
          }
          
          // typeä¸åŒåˆ™è·³å‡ºswitch
          break;
        }
      }
      // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œä»£è¡¨ï¼škeyç›¸åŒä½†æ˜¯typeä¸åŒ
      // å°†è¯¥fiberåŠå…¶å…„å¼Ÿfiberæ ‡è®°ä¸ºåˆ é™¤
      deleteRemainingChildren(returnFiber, child);
      break;
    } else {
      // keyä¸åŒï¼Œå°†è¯¥fiberæ ‡è®°ä¸ºåˆ é™¤
      deleteChild(returnFiber, child);
    }
    child = child.sibling;
  }

  // åˆ›å»ºæ–°Fiberï¼Œå¹¶è¿”å› ...çœç•¥
}
```

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­</font>

```javascript
// å½“å‰é¡µé¢æ˜¾ç¤ºçš„
ul > li * 3

// è¿™æ¬¡éœ€è¦æ›´æ–°çš„
ul > p

// ç”±äºæœ¬æ¬¡æ›´æ–°åªæœ‰ä¸€ä¸ªpèŠ‚ç‚¹ï¼Œæ‰€ä»¥æ˜¯å±äºâ€œåŒçº§åªæœ‰ä¸€å±‚â€ä¼šèµ° å•diffæ›´æ–°ã€‚
// reconcileSingleElement  ä¼šéå†ä¹‹å‰çš„3ä¸ªli ï¼Œå¯»æ‰¾æœ¬æ¬¡æ›´æ–°çš„pæ˜¯å¦ä¸ä¹‹å¯ä»¥å¤ç”¨ï¼Œ
// è¿™é‡Œå°±è¦åˆ†ä¸¤ç§æƒ…å†µäº†
1.KeyåŒ Typeä¸åŒ
ä»–ä¼šè¿™æ ·èµ°é€»è¾‘ï¼škeyåŒè¡¨ç¤ºæˆ‘ä»¬æ‰¾åˆ°äº†ä¸Šæ¬¡ä¸pç›¸åŒçš„fiber ï¼Œä½†æ˜¯type(p/li)ä¸åŒã€‚é‚£ä¹ˆä¸Šæ¬¡çš„li 
éƒ½ä¼šè¢«åˆ é™¤

2. Key ä¸åŒ ä¸Šæ¬¡çš„fiberä¸èƒ½è¢«på¤ç”¨ï¼Œç›´æ¥åˆ é™¤ä¸ä¹‹ç›¸å…³çš„æ‰€æœ‰å­èŠ‚ç‚¹
```

### å¤šèŠ‚ç‚¹Diff
æœ‰äº›è®¸çš„å¤æ‚ï¼Œä½†æ˜¯ä¸éš¾ã€‚

è¿™æ ·çš„jsx å°±ä»£è¡¨ä¸ºå¤šèŠ‚ç‚¹ 

```javascript

function List () {
  return (
    <ul>
      <li key="0">0</li>
      <li key="1">1</li>
      <li key="2">2</li>
      <li key="3">3</li>
    </ul>
  )
}
// ===> 

{
  $$typeof: Symbol(react.element),
  key: null,
  props: {
    children: [
      {$$typeof: Symbol(react.element), type: "li", key: "0", ref: null, props: {â€¦}, â€¦}
      {$$typeof: Symbol(react.element), type: "li", key: "1", ref: null, props: {â€¦}, â€¦}
      {$$typeof: Symbol(react.element), type: "li", key: "2", ref: null, props: {â€¦}, â€¦}
      {$$typeof: Symbol(react.element), type: "li", key: "3", ref: null, props: {â€¦}, â€¦}
    ]
  },
  ref: null,
  type: "ul"
}
```

ä»–ä¼šè¿›å…¥reconcileChildrenArray ä¸­å¼€å§‹åšdiff

ä¸»è¦åˆ†äº†ä¸‰ç§æƒ…å†µï¼šèŠ‚ç‚¹æ›´æ–°æ¯”å¦‚å±æ€§å˜åŒ–ï¼Œç±»å‹å˜åŒ–ï¼›èŠ‚ç‚¹æ–°å¢æˆ–åˆ›å»ºï¼›èŠ‚ç‚¹ä½ç½®å˜åŒ–ã€‚

ç”±äºä¸èƒ½ä½¿ç”¨åŒæŒ‡é’ˆè¿›è¡Œä¼˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸¤æ¬¡éå†

+ ç¬¬ä¸€è½®  éå†æ›´æ–°çš„èŠ‚ç‚¹
+ ç¬¬äºŒè½® éå†ä¸éœ€è¦ æ›´æ–° çš„èŠ‚ç‚¹

å…·ä½“çš„æƒ…å†µè¯´æ˜æ˜¯å¦‚ä½•è¿›è¡Œçš„



é‡ç‚¹å…³æ³¨ èŠ‚ç‚¹ä½ç½® ç§»åŠ¨çš„ fiberæ›´æ–°æ˜¯å¦‚ä½•è¿›è¡Œdiffçš„ï¼Œä»¥åŠä»–ä»¬çš„Demoæ ·å¼



ä¸‹é¢æ˜¯å¦ä¸€ä¸ªå…¨æµç¨‹çš„DEMO

```typescript
// ä¹‹å‰
abcd

// ä¹‹å
acdb

===ç¬¬ä¸€è½®éå†å¼€å§‹===
aï¼ˆä¹‹åï¼‰vs aï¼ˆä¹‹å‰ï¼‰  
keyä¸å˜ï¼Œå¯å¤ç”¨
æ­¤æ—¶ a å¯¹åº”çš„oldFiberï¼ˆä¹‹å‰çš„aï¼‰åœ¨ä¹‹å‰çš„æ•°ç»„ï¼ˆabcdï¼‰ä¸­ç´¢å¼•ä¸º0
æ‰€ä»¥ lastPlacedIndex = 0;

ç»§ç»­ç¬¬ä¸€è½®éå†...

cï¼ˆä¹‹åï¼‰vs bï¼ˆä¹‹å‰ï¼‰  
keyæ”¹å˜ï¼Œä¸èƒ½å¤ç”¨ï¼Œè·³å‡ºç¬¬ä¸€è½®éå†
æ­¤æ—¶ lastPlacedIndex === 0;
===ç¬¬ä¸€è½®éå†ç»“æŸ===

===ç¬¬äºŒè½®éå†å¼€å§‹===
newChildren === cdbï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œåˆ é™¤æ—§èŠ‚ç‚¹
oldFiber === bcdï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œæ’å…¥æ–°èŠ‚ç‚¹

å°†å‰©ä½™oldFiberï¼ˆbcdï¼‰ä¿å­˜ä¸ºmap

// å½“å‰oldFiberï¼šbcd
// å½“å‰newChildrenï¼šcdb

ç»§ç»­éå†å‰©ä½™newChildren

key === c åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = cï¼ˆä¹‹å‰ï¼‰.index;
æ­¤æ—¶ oldIndex === 2;  // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥c.index === 2
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;

å¦‚æœ oldIndex >= lastPlacedIndex ä»£è¡¨è¯¥å¯å¤ç”¨èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨
å¹¶å°† lastPlacedIndex = oldIndex;
å¦‚æœ oldIndex < lastplacedIndex è¯¥å¯å¤ç”¨èŠ‚ç‚¹ä¹‹å‰æ’å…¥çš„ä½ç½®ç´¢å¼•å°äºè¿™æ¬¡æ›´æ–°éœ€è¦æ’å…¥çš„ä½ç½®ç´¢å¼•ï¼Œä»£è¡¨è¯¥èŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨

åœ¨ä¾‹å­ä¸­ï¼ŒoldIndex 2 > lastPlacedIndex 0ï¼Œ
åˆ™ lastPlacedIndex = 2;
cèŠ‚ç‚¹ä½ç½®ä¸å˜

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šbd
// å½“å‰newChildrenï¼šdb

key === d åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = dï¼ˆä¹‹å‰ï¼‰.index;
oldIndex 3 > lastPlacedIndex 2 // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥d.index === 3
åˆ™ lastPlacedIndex = 3;
dèŠ‚ç‚¹ä½ç½®ä¸å˜

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šb
// å½“å‰newChildrenï¼šb

key === b åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = bï¼ˆä¹‹å‰ï¼‰.index;
oldIndex 1 < lastPlacedIndex 3 // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥b.index === 1
åˆ™ bèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨
===ç¬¬äºŒè½®éå†ç»“æŸ===

æœ€ç»ˆacd 3ä¸ªèŠ‚ç‚¹éƒ½æ²¡æœ‰ç§»åŠ¨ï¼ŒbèŠ‚ç‚¹è¢«æ ‡è®°ä¸ºç§»åŠ¨

```

```typescript
// ä¹‹å‰
abcd

// ä¹‹å
dabc

===ç¬¬ä¸€è½®éå†å¼€å§‹===
dï¼ˆä¹‹åï¼‰vs aï¼ˆä¹‹å‰ï¼‰  
keyæ”¹å˜ï¼Œä¸èƒ½å¤ç”¨ï¼Œè·³å‡ºéå†
===ç¬¬ä¸€è½®éå†ç»“æŸ===

===ç¬¬äºŒè½®éå†å¼€å§‹===
newChildren === dabcï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œåˆ é™¤æ—§èŠ‚ç‚¹
oldFiber === abcdï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œæ’å…¥æ–°èŠ‚ç‚¹

å°†å‰©ä½™oldFiberï¼ˆabcdï¼‰ä¿å­˜ä¸ºmap

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šabcd
// å½“å‰newChildren dabc

key === d åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = dï¼ˆä¹‹å‰ï¼‰.index;
æ­¤æ—¶ oldIndex === 3; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥d.index === 3
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 3 > lastPlacedIndex 0
åˆ™ lastPlacedIndex = 3;
dèŠ‚ç‚¹ä½ç½®ä¸å˜

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šabc
// å½“å‰newChildren abc

key === a åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = aï¼ˆä¹‹å‰ï¼‰.index; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥a.index === 0
æ­¤æ—¶ oldIndex === 0;
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 0 < lastPlacedIndex 3
åˆ™ aèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šbc
// å½“å‰newChildren bc

key === b åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = bï¼ˆä¹‹å‰ï¼‰.index; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥b.index === 1
æ­¤æ—¶ oldIndex === 1;
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 1 < lastPlacedIndex 3
åˆ™ bèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šc
// å½“å‰newChildren c

key === c åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = cï¼ˆä¹‹å‰ï¼‰.index; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥c.index === 2
æ­¤æ—¶ oldIndex === 2;
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 2 < lastPlacedIndex 3
åˆ™ cèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨

===ç¬¬äºŒè½®éå†ç»“æŸ===
```

# çŠ¶æ€æ›´æ–°
### æ¦‚è¿°
æˆ‘ä»¬å…ˆå¤ä¹ ä¸€ä¸‹å‰é¢æåˆ°å‡ ä¸ªå…³é”®èŠ‚ç‚¹ï¼š



Renderé˜¶æ®µçš„å¼€å§‹äº <font style="color:rgb(71, 101, 130);">performSyncWorkOnRoot</font><font style="color:rgb(44, 62, 80);">/</font><font style="color:rgb(71, 101, 130);">performConcurrentWorkOnRoot çš„è°ƒç”¨ï¼ˆåŒæ­¥/å¼‚æ­¥æ›´æ–°ï¼‰</font>

<font style="color:rgb(71, 101, 130);">Renderå®Œèµ°åˆ° Commité˜¶æ®µ </font><font style="color:rgb(71, 101, 130);">commitRoot  rootFiberä½œä¸ºå‚æ•°</font>

<font style="color:rgb(71, 101, 130);">æ‰§è¡Œä¸‹é¢çš„æ–¹æ³•å¯è§¦å‘Updateï¼Œ</font>

+ <font style="color:rgb(44, 62, 80);">ReactDOM.render</font>
+ <font style="color:rgb(44, 62, 80);">this.setState</font>
+ <font style="color:rgb(44, 62, 80);">this.forceUpdate</font>
+ <font style="color:rgb(44, 62, 80);">useState</font>
+ <font style="color:rgb(44, 62, 80);">useReducer</font>

<font style="color:rgb(71, 101, 130);">è™½ç„¶åœºæ™¯ä¸åŒï¼Œ</font><font style="color:rgb(44, 62, 80);">æ¯æ¬¡</font><font style="color:rgb(71, 101, 130);">çŠ¶æ€æ›´æ–°</font><font style="color:rgb(44, 62, 80);">éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä¿å­˜</font>**<font style="color:rgb(44, 62, 80);">æ›´æ–°çŠ¶æ€ç›¸å…³å†…å®¹</font>**<font style="color:rgb(44, 62, 80);">çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å«ä»–</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ã€‚åœ¨</font><font style="color:rgb(71, 101, 130);">renderé˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">çš„ </font><font style="color:rgb(71, 101, 130);">beginWork </font><font style="color:rgb(44, 62, 80);">ä¸­ä¼šæ ¹æ® </font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">è®¡ç®—æ–°çš„</font><font style="color:rgb(71, 101, 130);">state</font><font style="color:rgb(44, 62, 80);">ã€‚</font>



ç°åœ¨ â€œè§¦å‘çŠ¶æ€æ›´æ–°çš„fiberâ€ä¸Šå·²ç»å­˜åœ¨updateå¯¹è±¡äº†ï¼Œæˆ‘ä»¬è¦å¾€ä¸Šæ‰¾åˆ°å®ƒçš„rootFiber å› ä¸ºrenderèŠ‚ç‚¹æ˜¯ä» rootFiberå¼€å§‹å¾€ä¸‹éå†çš„ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨ <font style="color:rgb(71, 101, 130);">markUpdateLaneFromFiberToRoot å°±èƒ½æ‰¾åˆ°rootFiberï¼Œ</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">æ‰¾åˆ°rootFiberä¹‹å è¿›å…¥schedule ä¾æ®ä¼˜å…ˆçº§ è¿›è¡Œæ›´æ–°ï¼Œè°ƒç”¨çš„æ˜¯â€œensureRootIsScheduledâ€ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯  </font>

```typescript
if (newCallbackPriority === SyncLanePriority) {
  // ä»»åŠ¡å·²ç»è¿‡æœŸï¼Œéœ€è¦åŒæ­¥æ‰§è¡Œrenderé˜¶æ®µ
  newCallbackNode = scheduleSyncCallback(
    performSyncWorkOnRoot.bind(null, root)
  );
} else {
  // æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§å¼‚æ­¥æ‰§è¡Œrenderé˜¶æ®µ
  var schedulerPriorityLevel = lanePriorityToSchedulerPriority(
    newCallbackPriority
  );
  newCallbackNode = scheduleCallback(
    schedulerPriorityLevel,
    performConcurrentWorkOnRoot.bind(null, root)
  );
}
```

<font style="color:rgb(71, 101, 130);"> ä¾æ®å¼‚æ­¥/åŒæ­¥ï¼ˆå¼‚æ­¥å°±æ˜¯18çš„concureentæ¨¡å¼ï¼‰ åˆ†åˆ«è°ƒç”¨ ä¸¤ä¸ªæ–¹æ³•ï¼Œ</font>

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704508464708-dce4bcb2-15ea-48b7-a6aa-de55489de8f6.png)

è¿™ä¸ªè°ƒåº¦æ›´æ–° enusreRootIsSchedule ä¸­ä¼šè¿ç”¨åˆ°ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œåœ¨reactæºç ä¸­ åˆä¸‹é¢çš„ä¼˜å…ˆçº§

```typescript
export type PriorityLevel = 0 | 1 | 2 | 3 | 4 | 5;

// TODO: Use symbols?
export const NoPriority = 0;
export const ImmediatePriority = 1;
export const UserBlockingPriority = 2;
export const NormalPriority = 3;
export const LowPriority = 4;
export const IdlePriority = 5;
```

æ³¨æ„ï¼šäº‹ä»¶çš„ä¼˜å…ˆçº§æ˜¯ UserBlockingPriority è¦é«˜äº setStateä¼˜å…ˆçº§NormalPriority

# ä¼˜å…ˆçº§å’Œupdate
![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705561204995-44c1757b-5a4a-4a18-b5af-3efc82fee87b.png)

æ–°çš„state æ˜¯åŸºäº ä¼˜å…ˆçº§update è®¡ç®—å‡ºæ¥çš„ã€‚ä¸Šè¿°çš„å›¾æè¿°äº†è¿™æ ·çš„åœºæ™¯ï¼š

Fç»„ä»¶å…ˆå‘ç”Ÿäº†ä¸€æ¬¡normalçš„ä¼˜å…ˆçº§è°ƒåº¦ï¼Œç„¶åä»å½“å‰fiberå¼€å§‹æ‰¾åˆ°rootFiber ç„¶åä»¥normalçš„ä¼˜å…ˆçº§æ‰§è¡Œæ·±åº¦ä¼˜å…ˆçš„diffã€‚è¿™ä¸ªè¿‡ç¨‹è¿˜æ²¡æœ‰ç»“æŸç„¶ååˆè§¦å‘äº†ä¸€ä¸ª UserBlockingPriorityçš„é«˜ä¼˜å…ˆçº§ï¼Œç„¶ååˆä¼šå¼€å§‹æ·±åº¦ä¼˜å…ˆéå†ï¼ŒåŸæ¥çš„normalä¼˜å…ˆçº§ä¼šè¢«æ‰“æ–­ã€‚

è§‚å¯Ÿä¸‹é¢çš„ä¾‹å­

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1705561618493-c73eaa31-9938-4882-aff6-62e2c48ce186.png)

ä½ ä¼šå‘ç° r16 çš„ è¡¨ç°ä¼šæ˜¯è¿™æ ·  
ï¼š0-1-3

r18 æœ‰å¹¶å‘ä¼˜å…ˆçº§æ¦‚å¿µï¼Œæ‰€ä»¥ä½ çœ‹åˆ°è¿™æ ·

ï¼š0-2-3





### å¿ƒæ™ºæ¨¡å‹
ä¸»è¦åˆ†ä¸¤ç§ â€œåŒæ­¥æ›´æ–°çš„Reactâ€ â€œå¼‚æ­¥æ›´æ–°çš„Reactâ€ï¼Œ



åŒæ­¥æ›´æ–° ç±»ä¼¼ä»£ç æäº¤ï¼Œå…ˆæŠŠå‰é¢å¼€å‘ä¸­çš„åŠŸèƒ½å®Œæˆäº†ä¹‹åæ‰ä¿®å¤D Bug

<font style="color:rgb(44, 62, 80);">åœ¨</font><font style="color:rgb(71, 101, 130);">React</font><font style="color:rgb(44, 62, 80);">ä¸­ï¼Œæ‰€æœ‰é€šè¿‡</font><font style="color:rgb(71, 101, 130);">ReactDOM.render</font><font style="color:rgb(44, 62, 80);">åˆ›å»ºçš„åº”ç”¨ï¼ˆå…¶ä»–åˆ›å»ºåº”ç”¨çš„æ–¹å¼å‚è€ƒ</font>[ReactDOM.renderä¸€èŠ‚](https://kasong.gitee.io/just-react/state/reactdom.html#react%E7%9A%84%E5%85%B6%E4%BB%96%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0)<font style="color:rgb(44, 62, 80);">ï¼‰éƒ½æ˜¯é€šè¿‡ç±»ä¼¼çš„æ–¹å¼</font><font style="color:rgb(71, 101, 130);">æ›´æ–°çŠ¶æ€</font><font style="color:rgb(44, 62, 80);">ã€‚</font>

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704508829167-611f5a50-54c5-4f0e-bb74-2a4fcad2d494.png)





å¼‚æ­¥æ›´æ–° ç±»ä¼¼ä»£ç æäº¤ ï¼Œå…ˆæŠŠä¸»å¹²ä¸Šçš„D bugä¿®å¤ï¼Œç„¶åé€šè¿‡git rebase ï¼ŒæŠŠå…¶ä»–çš„ ABC åŠŸèƒ½ merge ä¸€æ¬¡æ²¡æœ‰bugçš„ master

<font style="color:rgb(71, 101, 130);">ReactDOM.createBlockingRoot</font><font style="color:rgb(44, 62, 80);">å’Œ</font><font style="color:rgb(71, 101, 130);">ReactDOM.createRoot</font><font style="color:rgb(44, 62, 80);">åˆ›å»ºçš„åº”ç”¨ä¼šé‡‡ç”¨</font><font style="color:rgb(71, 101, 130);">å¹¶å‘</font><font style="color:rgb(44, 62, 80);">çš„æ–¹å¼</font><font style="color:rgb(71, 101, 130);">æ›´æ–°çŠ¶æ€</font><font style="color:rgb(44, 62, 80);">ã€‚</font>

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704508873790-adc22d9e-11f9-4284-b84a-9838d82587fd.png)

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704508886606-65b9561d-a23d-4412-bb33-abd91a630ef4.png)

### Update
<font style="color:rgb(44, 62, 80);">ä¸€å…±ä¸‰ç§ç»„ä»¶ï¼ˆ</font><font style="color:rgb(71, 101, 130);">HostRoot</font><font style="color:rgb(44, 62, 80);"> | </font><font style="color:rgb(71, 101, 130);">ClassComponent</font><font style="color:rgb(44, 62, 80);"> | </font><font style="color:rgb(71, 101, 130);">FunctionComponent</font><font style="color:rgb(44, 62, 80);">ï¼‰å¯ä»¥è§¦å‘æ›´æ–°ã€‚</font>

<font style="color:rgb(71, 101, 130);">HostRoot</font><font style="color:rgb(44, 62, 80);"> | </font><font style="color:rgb(71, 101, 130);">ClassComponent å…±ç”¨ä¸€å¥—æ›´æ–°æœºåˆ¶</font>

<font style="color:rgb(71, 101, 130);">FunctionComponent ç‹¬ç«‹ç”¨ä¸€å¥—æ›´æ–°æœºåˆ¶</font>

<font style="color:rgb(71, 101, 130);">æˆ‘ä»¬å…ˆè®² ç¬¬ä¸€å¥—æ›´æ–°æœºåˆ¶ </font>

<font style="color:rgb(71, 101, 130);">Updateçš„ç»“æ„</font>

```typescript
const update: Update<*> = {
  eventTime, // ä¸éœ€è¦å…³æ³¨
  lane, // ä¸éœ€è¦å…³æ³¨ ä¸updateä¼˜å…ˆçº§ç›¸å…³
  suspenseConfig, // ä¸éœ€è¦å…³æ³¨ ä¸ suspense ç›¸å…³
  tag: UpdateState, 
  // æ›´æ–°çš„ç±»å‹ UpdateState | ReplaceState  | ForceUpdate | CaptureUpdateã€‚
	payload: null,
  // æ›´æ–°ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼ŒClassComponent å°±æ˜¯setStateç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒHostComponet
  // å°±æ˜¯ä¼ å…¥çš„<APP />
  callback: null, 
  // åœ¨ commit é˜¶æ®µçš„ layout å­é˜¶æ®µä¸€èŠ‚ä¸­æåˆ°çš„å›è°ƒå‡½æ•°ã€‚

  next: null,
  //ä¸å…¶ä»–Updateè¿æ¥å½¢æˆé“¾è¡¨ã€‚
  };
```

<font style="color:rgb(71, 101, 130);">Updateä¸Fiberçš„è”ç³»æ˜¯</font>

<font style="color:rgb(71, 101, 130);">Fiber ç»„æˆ FiberTree ï¼Œç„¶åæ¯ä¸ªFiberä¸Šçš„Update ä¼šä¸²è”åœ¨ä¸€èµ·æ„å»ºä¸€ä¸ªé“¾è¡¨ å­˜å‚¨åˆ° fiber.</font><font style="color:rgb(71, 101, 130);">updateQueue ä¸­ï¼ˆFiberèŠ‚ç‚¹</font><font style="color:rgb(44, 62, 80);">æœ€å¤šåŒæ—¶å­˜åœ¨ä¸¤ä¸ª</font><font style="color:rgb(71, 101, 130);">updateQueue</font><font style="color:rgb(71, 101, 130);">ï¼‰</font>

+ <font style="color:rgb(71, 101, 130);">current fiber</font><font style="color:rgb(44, 62, 80);">ä¿å­˜çš„</font><font style="color:rgb(71, 101, 130);">updateQueue</font><font style="color:rgb(44, 62, 80);">å³</font><font style="color:rgb(71, 101, 130);">current updateQueue</font>
+ <font style="color:rgb(71, 101, 130);">workInProgress fiber</font><font style="color:rgb(44, 62, 80);">ä¿å­˜çš„</font><font style="color:rgb(71, 101, 130);">updateQueue</font><font style="color:rgb(44, 62, 80);">å³</font><font style="color:rgb(71, 101, 130);">workInProgress updateQueue</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">UpdateQueueç»“æ„å¦‚ä¸‹</font>

```tsx
const queue: UpdateQueue<State> = {
  baseState: fiber.memoizedState, 
  // æœ¬æ¬¡æ›´æ–°å‰è¯¥FiberèŠ‚ç‚¹çš„stateï¼ŒUpdateåŸºäºè¯¥stateè®¡ç®—æ›´æ–°åçš„stateã€‚
  // ç±»ä¼¼æˆ‘ä»¬åœ¨å¿ƒæ™ºæ¨¡å‹ä¸­è¯´çš„masterä¸»å¹²
  firstBaseUpdate: null,
  lastBaseUpdate: null,
  // æœ¬æ¬¡æ›´æ–°å‰ è¯¥FiberèŠ‚ç‚¹å·²ä¿å­˜çš„Update, ä¸€ä¸ªæ˜¯é“¾è¡¨å¤´ å’Œé“¾è¡¨å°¾å·´
  // ç±»ä¼¼æˆ‘ä»¬åœ¨å¿ƒæ™ºæ¨¡å‹ä¸­è¯´çš„  æ‰§è¡Œgit rebaseåŸºäºçš„commitï¼ˆèŠ‚ç‚¹Dï¼‰ã€‚
  shared: {
    pending: null,
  },
  // è§¦å‘æ›´æ–°æ—¶ï¼Œäº§ç”Ÿçš„Updateä¼šä¿å­˜åœ¨shared.pendingä¸­å½¢æˆå•å‘ç¯çŠ¶é“¾è¡¨ã€‚
  // updateçš„æ—¶å€™ä¼šè¢«å‰ªå¼€ è¿æ¥åˆ° lastBaseUpdate å
  // ç±»ä¼¼æˆ‘ä»¬åœ¨å¿ƒæ™ºæ¨¡å‹ä¸­è¯´çš„ ABC commit
  effects: null,
  // ä¿å­˜update.calback !== nullçš„Update
};
```

ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜ï¼›



### æ·±å…¥ç†è§£è°ƒåº¦ä¼˜å…ˆçº§
<font style="color:rgb(71, 101, 130);">reacté€šè¿‡Scheduler ï¼ˆå…·ä½“å†…éƒ¨è°ƒç”¨ä¸º runWithPriority æ–¹æ³•ï¼‰è°ƒåº¦taskï¼Œé‚£ä¸ªä¼˜å…ˆçº§é«˜ æ˜¯ä¾æ® update.lane æ¥å†³å®šçš„ã€‚</font>

ä¸¾ä¾‹è¯´æ˜

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704510639456-1051fe0a-aad4-4521-83d9-f647cd027bfe.png)



å¦‚ä½•ä¿è¯Updateä¸ä¸¢å¤±ï¼Ÿ

<font style="color:rgb(44, 62, 80);">å½“</font><font style="color:rgb(71, 101, 130);">renderé˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">è¢«ä¸­æ–­åé‡æ–°å¼€å§‹æ—¶ï¼Œä¼šåŸºäº</font><font style="color:rgb(71, 101, 130);">current updateQueue</font><font style="color:rgb(44, 62, 80);">å…‹éš†å‡º</font><font style="color:rgb(71, 101, 130);">workInProgress updateQueue</font><font style="color:rgb(44, 62, 80);">ã€‚ç”±äº</font><font style="color:rgb(71, 101, 130);">current updateQueue.lastBaseUpdate</font><font style="color:rgb(44, 62, 80);">å·²ç»ä¿å­˜äº†ä¸Šä¸€æ¬¡çš„</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ï¼Œæ‰€ä»¥ä¸ä¼šä¸¢å¤±ã€‚</font>

<font style="color:rgb(44, 62, 80);">å½“</font><font style="color:rgb(71, 101, 130);">commité˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">å®Œæˆæ¸²æŸ“ï¼Œç”±äº</font><font style="color:rgb(71, 101, 130);">workInProgress updateQueue.lastBaseUpdate</font><font style="color:rgb(44, 62, 80);">ä¸­ä¿å­˜äº†ä¸Šä¸€æ¬¡çš„</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ï¼Œæ‰€ä»¥ </font><font style="color:rgb(71, 101, 130);">workInProgress Fiberæ ‘</font><font style="color:rgb(44, 62, 80);">å˜æˆ</font><font style="color:rgb(71, 101, 130);">current Fiberæ ‘</font><font style="color:rgb(44, 62, 80);">åä¹Ÿä¸ä¼šé€ æˆ</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ä¸¢å¤±ã€‚</font>

å¦‚ä½•ä¿å­˜ ä¾èµ–çš„è¿ç»­æ€§ï¼Ÿ

å…·ä½“æ¥è¯´ ä¼šç»ç†å¤šæ¬¡render å¯¹æ¯”ä¸‹é¢çš„ä¾‹å­ (<font style="color:rgb(71, 101, 130);">æ•°å­—</font><font style="color:rgb(44, 62, 80);">ä»£è¡¨</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">ï¼Œå€¼è¶Šä½</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">è¶Šé«˜</font>)

```plain
baseState: ''
shared.pending: A1 --> B2 --> C1 --> D2
```

ç¬¬ä¸€æ¬¡render é«˜ä¼˜å…ˆçº§ä¸º A1 - C1 ( ç”±äºB2ä¼˜å…ˆçº§æ²¡C1 é«˜ï¼Œ<font style="color:rgb(44, 62, 80);">æ‰€ä»¥ä»–åŠå…¶åé¢çš„æ‰€æœ‰</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ä¼šè¢«ä¿å­˜åœ¨</font><font style="color:rgb(71, 101, 130);">baseUpdate</font><font style="color:rgb(44, 62, 80);">ä¸­ä½œä¸ºä¸‹æ¬¡æ›´æ–°çš„</font><font style="color:rgb(71, 101, 130);">Update</font><font style="color:rgb(44, 62, 80);">ï¼ˆå³</font><font style="color:rgb(71, 101, 130);">B2 C1 D2</font><font style="color:rgb(44, 62, 80);">ï¼‰ã€‚</font> )

```plain
baseState: ''
baseUpdate: null
renderé˜¶æ®µä½¿ç”¨çš„Update: [A1, C1]
memoizedState: 'AC'
```



ç¬¬äºŒæ¬¡Render é«˜ä¼˜å…ˆçº§ä¸º B2 - C1- D2	

```plain
baseState: 'A'
baseUpdate: B2 --> C1 --> D2
renderé˜¶æ®µä½¿ç”¨çš„Update: [B2, C1, D2]
memoizedState: 'ABCD'
```

### ReactDOM.render
æˆ‘ä»¬ä»å¤´åˆ°å°¾ï¼ŒæŠŠå‰é¢çš„æµç¨‹å…¨éƒ¨ç»™ä¸²è”ä¸€éã€‚

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704514502076-6f9c7157-ac24-400c-932e-d1b3520f3bb7.png)

React å…·å¤‡å¤šç§å…¥å£å‡½æ•°ï¼Œ

+ <font style="color:rgb(71, 101, 130);">legacy</font><font style="color:rgb(44, 62, 80);"> </font><font style="color:rgb(44, 62, 80);">--</font><font style="color:rgb(44, 62, 80);"> </font><font style="color:rgb(71, 101, 130);">ReactDOM.render(<App />, rootNode)</font>
+ <font style="color:rgb(71, 101, 130);">blocking</font><font style="color:rgb(44, 62, 80);"> </font><font style="color:rgb(44, 62, 80);">--</font><font style="color:rgb(44, 62, 80);"> </font><font style="color:rgb(71, 101, 130);">ReactDOM.createBlockingRoot(rootNode).render(<App />)</font>
+ <font style="color:rgb(71, 101, 130);">concurrent</font><font style="color:rgb(44, 62, 80);"> -- </font><font style="color:rgb(71, 101, 130);">ReactDOM.createRoot(rootNode).render(<App />) ï¼ˆç›®å‰React18 å°±æ˜¯è¿™ç§é»˜è®¤æ¨¡å¼ï¼‰</font><font style="color:rgb(71, 101, 130);">ä»»åŠ¡ä¸­æ–­/ä»»åŠ¡ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">éƒ½æ˜¯é’ˆå¯¹</font><font style="color:rgb(71, 101, 130);">concurrent</font><font style="color:rgb(44, 62, 80);">æ¨¡å¼ã€‚</font>

<font style="color:rgb(71, 101, 130);"></font>

### this.setState
å…¶å†…éƒ¨ä¼šè°ƒç”¨ <font style="color:rgb(71, 101, 130);">this.updater.enqueueSetStateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢å°±æ˜¯ç†Ÿæ‚‰çš„ä¸€å¥—</font>

<font style="color:rgb(71, 101, 130);">åˆ›å»ºupdate</font><font style="color:rgb(44, 62, 80);">åˆ°</font><font style="color:rgb(71, 101, 130);">è°ƒåº¦update</font><font style="color:rgb(44, 62, 80);">çš„æµç¨‹äº†ã€‚</font>

<font style="color:rgb(44, 62, 80);">ç„¶åå†…éƒ¨è¿˜å¯ä»¥ å¯¹this.forceUpdate (å¼ºåˆ¶æ›´æ–°)ï¼Œå®ƒä¼šè°ƒç”¨åˆ° </font><font style="color:rgb(71, 101, 130);">enqueueForceUpdate ä¸­ï¼Œå®ƒé‡Œé¢è¿›è¡Œäº†ä¸€æ¬¡èµ‹å€¼ update.tag = ForceUpdateï¼Œ</font>

<font style="color:rgb(71, 101, 130);">åœ¨ClassComponent æ˜¯å¦æ›´æ–°ä¸Š æœ‰ä¸€ä¸ªé‡è¦çš„æ¡ä»¶ checkHasForceUpdateAfterProcessingï¼Œé‡Œé¢å°±æ˜¯åœ¨åˆ¤æ–­è¿™ä¸ªtag </font>

# Hook
## ç†å¿µ
ä»è®¾è®¡ç†å¿µå¼€å§‹å¨å¨ï¼Œ

<font style="color:rgb(71, 101, 130);">React</font><font style="color:rgb(44, 62, 80);">çš„æ¶æ„éµå¾ª</font><font style="color:rgb(71, 101, 130);">schedule - render - commit</font><font style="color:rgb(44, 62, 80);">çš„è¿è¡Œæµç¨‹ï¼Œè¿™ä¸ªæµç¨‹æ˜¯</font><font style="color:rgb(71, 101, 130);">React</font><font style="color:rgb(44, 62, 80);">ä¸–ç•Œæœ€åº•å±‚çš„è¿è¡Œè§„å¾‹ã€‚</font>

å¦‚æœè¯´ æŠŠ react ClassComponent è®¤ä¸ºæ˜¯ reactä¸–ç•Œçš„ åŸå­ï¼Œé‚£ä¹ˆhookså°±æ˜¯reactä¸–ç•Œçš„ ç”µå­ ã€‚

hooksçš„ä¸€ä¸ªé‡å¤§è®¾è®¡ç›®çš„æ˜¯ï¼š **<font style="color:rgb(44, 62, 80);">ä½¿åŒä¸€ç»„ä»¶åœ¨åŒä¸€æ—¶é—´å¯ä»¥æ‹¥æœ‰å¤šä¸ªçŠ¶æ€ï¼Œå³åŒä¸€ä¸ªç»„ä»¶å¯ä»¥æ‹¥æœ‰å¤šæ¡æ—¶é—´çº¿</font>**<font style="color:rgb(44, 62, 80);">ã€‚è¿™æ˜¯Classæ— æ³•åšåˆ°çš„</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">ä½¿ç”¨</font>[useDeferredValue](https://zh-hans.reactjs.org/docs/concurrent-mode-reference.html#usedeferredvalue)<font style="color:rgb(44, 62, 80);">ä½¿åŒä¸€ç»„ä»¶çš„æŸä¸ª</font><font style="color:rgb(71, 101, 130);">çŠ¶æ€</font><font style="color:rgb(44, 62, 80);">åœ¨åŒä¸€æ—¶é—´æ‹¥æœ‰å¤šæ¡æ—¶é—´çº¿ã€‚</font>

<font style="color:rgb(44, 62, 80);">ä¸åŒæ—¶é—´çº¿é‡åˆçš„æ—¶é—´è§†</font>**<font style="color:rgb(44, 62, 80);">ç”¨æˆ·è®¾å¤‡çš„æ€§èƒ½</font>**<font style="color:rgb(44, 62, 80);">ä¸åŒè€Œä¸åŒã€‚</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">æˆªæ­¢2024/01/07æ—¥ ï¼Œreactå®˜æ–¹æ–‡æ¡£æ¨¡å¼å·²ç»å¼€å§‹ä½¿ç”¨ä½¿ç”¨ react18 å¹¶ä¸”ä¸º </font><font style="color:rgb(71, 101, 130);">Concurrent Mode æ¨¡å¼è€Œä¸å†æ˜¯ä¹‹å‰çš„</font><font style="color:rgb(71, 101, 130);">legacy</font><font style="color:rgb(44, 62, 80);">  æ¨¡å¼ï¼ˆreact 17ï¼‰</font><font style="color:rgb(71, 101, 130);"> ï¼Œ</font><font style="color:rgb(44, 62, 80);">è€Œ</font><font style="color:rgb(71, 101, 130);">Hooks</font><font style="color:rgb(44, 62, 80);">æ˜¯èƒ½å¤Ÿæœ€å¤§é™åº¦å‘æŒ¥</font><font style="color:rgb(71, 101, 130);">Concurrent Mode</font><font style="color:rgb(44, 62, 80);">æ½œåŠ›çš„</font><font style="color:rgb(71, 101, 130);">Component</font><font style="color:rgb(44, 62, 80);">æ„å»ºæ–¹å¼ã€‚</font>

## <font style="color:rgb(44, 62, 80);">ç®€åŒ–ç‰ˆæœ¬Hookå®ç°</font>
useState çš„å·¥ä½œåˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œ

1. é€šè¿‡æŸäº›é€”å¾„äº§ç”Ÿ æ›´æ–°ï¼ˆæ¯”å¦‚setState(Hook)ï¼‰ï¼Œæ›´æ–°å°†å¯¼è‡´update 
2. render æŠŠ useStateè¿”å›çš„æ•°æ®ä½œä¸ºç»“æœ



æ›´æ–°çš„æœ¬è´¨æ˜¯ä¸€ç§ç±»ä¼¼ä¸‹é¢çš„æ•°æ®ç»“æ„

```javascript
const update = {
  // æ›´æ–°æ‰§è¡Œçš„å‡½æ•°
  action,
  // ä¸åŒä¸€ä¸ªHookçš„å…¶ä»–æ›´æ–°å½¢æˆé“¾è¡¨
  next: null,
};

// è¿™æ ·çš„ä¾‹å­ä¸­ å°±ä¼šäº§ç”Ÿä¸‰ä¸ª update
// ä¹‹å‰
return <p onClick={() => updateNum((num) => num + 1)}>{num}</p>;

// ä¹‹å
return (
  <p
    onClick={() => {
      updateNum((num) => num + 1);
      updateNum((num) => num + 1);
      updateNum((num) => num + 1);
    }}
  >
    {num}
  </p>
);

```

è¿™ä¸‰ä¸ªupdateé€šè¿‡ä¸‹é¢çš„ä»£ç è¿›è¡Œè¿æ¥ï¼Œåœ¨ä¸€èµ·ï¼ˆç¯å½¢å•å‘é“¾è¡¨ï¼‰

```javascript
function dispatchAction(queue, action) {
  // åˆ›å»ºupdate
  const update = {
    action,
    next: null,
  };

  // ç¯çŠ¶å•å‘é“¾è¡¨æ“ä½œ
  if (queue.pending === null) {
    update.next = update;
  } else {
    update.next = queue.pending.next;
    queue.pending.next = update;
  }
  queue.pending = update;

  // æ¨¡æ‹ŸReactå¼€å§‹è°ƒåº¦æ›´æ–°
  schedule();
}
```

è°ƒç”¨updateNum å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ dispatchAction

ç¬¬ä¸€ä¸ªupdateä¼šäº§ç”Ÿä¸‹é¢çš„æ•°æ®ç»“æ„

```javascript
queue.pending = u0 ---> u0
                ^       |
                |       |
                ---------
```

  
ç¬¬äºŒä¸ªupdateä¼šäº§ç”Ÿä¸‹é¢çš„æ•°æ®ç»“æ„

```javascript
queue.pending = u1 ---> u0
                ^       |
                |       |
                ---------
```

åœ¨éå†ä»–ä»¬çš„æ—¶å€™åªéœ€è¦è°ƒæ•´æŒ‡é’ˆ,æŒ‡å‘ç¬¬ä¸€ä¸ªæ’å…¥çš„updateå°±å¥½äº†ã€‚

<font style="color:rgb(71, 101, 130);">æ›´æ–°</font><font style="color:rgb(44, 62, 80);">äº§ç”Ÿçš„</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(44, 62, 80);">å¯¹è±¡ä¼šä¿å­˜åœ¨</font><font style="color:rgb(71, 101, 130);">queue</font><font style="color:rgb(44, 62, 80);">ä¸­ã€‚å¯¹äºFunctionCompnentæ¥è¯´å®ƒå­˜åœ¨fiberä¸Š</font>

hookçš„æ•°æ®ç»“æ„:

```javascript
// Appç»„ä»¶å¯¹åº”çš„fiberå¯¹è±¡
const fiber = {
  // ä¿å­˜è¯¥FunctionComponentå¯¹åº”çš„Hooksé“¾è¡¨
  // fiber.memoizedStateä¸­ä¿å­˜çš„Hookçš„æ•°æ®ç»“æ„ã€‚
  memoizedState: null,
  // æŒ‡å‘Appå‡½æ•°
  stateNode: App,
};

// hooks æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„
hook = {
  // ä¿å­˜updateçš„queueï¼Œå³ä¸Šæ–‡ä»‹ç»çš„queue
  queue: {
    pending: null,
  },
  // ä¿å­˜hookå¯¹åº”çš„state
  memoizedState: initialState,
  // ä¸ä¸‹ä¸€ä¸ªHookè¿æ¥å½¢æˆå•å‘æ— ç¯é“¾è¡¨
  next: null,
};


```



updateå’Œhookçš„å…³ç³»: .

<font style="color:rgb(107, 89, 0);">æ¯ä¸ª</font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(107, 89, 0);">å¯¹åº”ä¸€ä¸ª</font><font style="color:rgb(71, 101, 130);">hook</font><font style="color:rgb(107, 89, 0);">å¯¹è±¡ã€‚äº§ç”Ÿçš„</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(107, 89, 0);">ä¿å­˜åœ¨</font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(107, 89, 0);">å¯¹åº”çš„</font><font style="color:rgb(71, 101, 130);">hook.queue</font><font style="color:rgb(107, 89, 0);">ä¸­ã€‚</font>

<font style="color:rgb(107, 89, 0);"></font>

æ¨¡æ‹Ÿä¸€äº›Scheduleçš„è°ƒåº¦è¿‡ç¨‹ï¼Œå®é™…ä¸Šä¸»è¦è¿˜æ˜¯åˆ†ä¸¤ä¸ªåœºæ™¯ mount å’Œupdateçš„æ—¶å€™ã€‚æ•°æ®çš„ä¿å­˜å’Œé“¾è¡¨çš„ç§»åŠ¨ã€‚è®¡ç®—stateä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚ä¸‹é¢æ˜¯useStateçš„éƒ¨åˆ†æºç 

```typescript
function useState(initialState) {
  let hook;
  
  // é¦–æ¬¡renderæ—¶æ˜¯mount
  if (isMount) {
      //  ...mountæ—¶éœ€è¦ç”Ÿæˆhookå¯¹è±¡
    hook = {
      queue: {
        pending: null,
      },
      memoizedState: initialState,
      next: null,
    };
    if (!fiber.memoizedState) {
       // å°†hookæ’å…¥fiber.memoizedStateé“¾è¡¨æœ«å°¾
      fiber.memoizedState = hook;
    } else {
      workInProgressHook.next = hook;
    }
     // ç§»åŠ¨workInProgressHookæŒ‡é’ˆ
    workInProgressHook = hook;
  } else {
     // ...updateæ—¶ä»workInProgressHookä¸­å–å‡ºè¯¥useStateå¯¹åº”çš„hook
    //  // updateæ—¶æ‰¾åˆ°å¯¹åº”hook å¹¶ä¸”ç§»åŠ¨æŒ‡é’ˆ
    hook = workInProgressHook;
    workInProgressHook = workInProgressHook.next;
  }
  
 // updateæ‰§è¡Œå‰çš„åˆå§‹state
  let baseState = hook.memoizedState;
  if (hook.queue.pending) {
    // ...æ ¹æ®queue.pendingä¸­ä¿å­˜çš„updateæ›´æ–°state
    //  // è·å–updateç¯çŠ¶å•å‘é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªupdate
    let firstUpdate = hook.queue.pending.next;

    do {
       // æ‰§è¡Œupdate action
      const action = firstUpdate.action;
      baseState = action(baseState);
      firstUpdate = firstUpdate.next;
    } while (firstUpdate !== hook.queue.pending.next);

      // æ¸…ç©ºqueue.pending
    hook.queue.pending = null;
  }
  
  // å°†update actionæ‰§è¡Œå®Œåçš„stateä½œä¸ºmemoizedState
  hook.memoizedState = baseState;

  return [baseState, dispatchAction.bind(null, hook.queue)];
}
```

<font style="color:#DF2A3F;">è¿™é‡Œæ˜¯æˆ‘ä»¬è‡ªå·±mockçš„ä¸€ä¸ªuseState é‡è¦ï¼</font>

```javascript
let workInProgressHook;
let isMount = true;

const fiber = {
  memoizedState: null,
  stateNode: App
};

function schedule() {
  workInProgressHook = fiber.memoizedState;
  const app = fiber.stateNode();
  isMount = false;
  return app;
}

function dispatchAction(queue, action) {
  const update = {
    action,
    next: null
  }
  if (queue.pending === null) {
    update.next = update;
  } else {
    update.next = queue.pending.next;
    queue.pending.next = update;
  }
  queue.pending = update;

  schedule();
}

function useState(initialState) {
  let hook;

  if (isMount) {
    hook = {
      queue: {
        pending: null
      },
      memoizedState: initialState,
      next: null
    }
    if (!fiber.memoizedState) {
      fiber.memoizedState = hook;
    } else {
      workInProgressHook.next = hook;
    }
    workInProgressHook = hook;
  } else {
    hook = workInProgressHook;
    workInProgressHook = workInProgressHook.next;
  }

  let baseState = hook.memoizedState;
  if (hook.queue.pending) {
    let firstUpdate = hook.queue.pending.next;

    do {
      const action = firstUpdate.action;
      baseState = action(baseState);
      firstUpdate = firstUpdate.next;
    } while (firstUpdate !== hook.queue.pending)

      hook.queue.pending = null;
  }
  hook.memoizedState = baseState;

  return [baseState, dispatchAction.bind(null, hook.queue)];
}

function App() {
  const [num, updateNum] = useState(0);

  console.log(`${isMount ? 'mount' : 'update'} num: `, num);

  return {
    click() {
      updateNum(num => num + 1);
    }
  }
}

window.app = schedule();
```

## Hookçš„æ•°æ®ç»“æ„
åœ¨æ­£å¼çš„Reactä¸­ æˆ‘ä»¬å¹¶ä¸æ˜¯é€šè¿‡isMount æ¥åŒºåˆ† mount å’Œupdateï¼Œåœ¨ä¸åŒé˜¶æ®µReactä¸åŒçš„Hookå¯¹è±¡ï¼Œ<font style="color:rgb(44, 62, 80);">è¿™ç±»å¯¹è±¡åœ¨æºç ä¸­è¢«ç§° </font>dispacter ï¼Œä»–ä»¬æ˜¯åˆ†æˆäº†ä¸¤ç±»(mountæ—¶å’Œupdateæ—¶), å½“ç„¶dispatcher ä¸ä»…ä»…åªæœ‰è¿™ä¸¤ç±»å“ˆ è¿˜æœ‰æ›´å¤šçš„ç±»å‹ã€‚ä¸‹é¢æ˜¯ éƒ¨åˆ†æºä»£ç 

```javascript
ReactCurrentDispatcher.current =
      current === null || current.memoizedState === null
        ? HooksDispatcherOnMount
        : HooksDispatcherOnUpdate;  
```

 hookçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼šæ³¨æ„åŒºåˆ† fiberçš„<font style="color:rgb(71, 101, 130);">memoizedState å’Œ hookçš„memoizedState ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿å“ˆï¼Œå‰è€…æ˜¯fiberä¸Šä¿å­˜çš„hooké“¾è¡¨ï¼Œåè€…æ˜¯hookä¸Šä¿å­˜çš„å•ä¸€æ•°æ®ã€‚</font>

<font style="color:rgb(71, 101, 130);"></font>

```javascript
const hook: Hook = {
  memoizedState: null,

  baseState: null,
  baseQueue: null,
  queue: null,

  next: null,
};
```

![](https://cdn.nlark.com/yuque/0/2024/png/1627571/1704795002597-8ea0d246-2eb2-49b7-b3df-c6d84137af19.png)

## useStateå’ŒuseReducer
<font style="color:rgb(44, 62, 80);">æœ¬è´¨æ¥è¯´ï¼Œ</font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(44, 62, 80);">åªæ˜¯é¢„ç½®äº†</font><font style="color:rgb(71, 101, 130);">reducer</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">useReducer</font><font style="color:rgb(44, 62, 80);">ã€‚ä¸‹é¢æ˜¯ä¸€éƒ¨åˆ†æœ‰å…³useStateå’ŒuseReducerçš„æºä»£ç ã€‚</font>

```javascript
function useState(initialState) {
  var dispatcher = resolveDispatcher();
  return dispatcher.useState(initialState);
}
function useReducer(reducer, initialArg, init) {
  var dispatcher = resolveDispatcher();
  return dispatcher.useReducer(reducer, initialArg, init);
}
```

<font style="color:rgb(44, 62, 80);">è¿™ä¸¤ä¸ªhook çš„å·¥ä½œæµç¨‹åˆ†æˆäº† </font>**<font style="color:#DF2A3F;">å£°æ˜ å’Œ è°ƒç”¨ </font>**<font style="color:rgb(44, 62, 80);">ä¸¤ä¸ªé˜¶æ®µ (å£°æ˜çš„æ—¶å€™ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œç„¶åæ‰§è¡Œæ›´æ–°çš„æ—¶å€™å°±ä¼šæ‰§è¡Œä¸€æ¬¡)</font>



mount æ—¶ï¼š

å£°æ˜æ˜¯åœ¨ FunctionComponent è¿›å…¥renderé˜¶æ®µçš„beginwork è°ƒç”¨ [renderWithHooks](https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1419) å‘ç”Ÿçš„ã€‚

è¿™ä¸ªfunction ä¼šæŒ‰ç…§ mount /update åœºæ™¯åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚

<font style="color:rgb(71, 101, 130);">mount</font><font style="color:rgb(44, 62, 80);">æ—¶ï¼Œ</font><font style="color:rgb(71, 101, 130);">useReducer</font><font style="color:rgb(44, 62, 80);">ä¼šè°ƒç”¨</font>[mountReducer](https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L638)<font style="color:rgb(44, 62, 80);">ï¼Œ</font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(44, 62, 80);">ä¼šè°ƒç”¨</font>[mountState](https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1143)<font style="color:rgb(44, 62, 80);">ã€‚</font>

<font style="color:rgb(44, 62, 80);">å¯¹äºä¸Šé¢çš„ä¸¤ä¸ªhookå®é™…ä¸Šéƒ½ä¼šåˆ›å»º queueï¼Œqueueçš„æ•°æ®ç»“æ„æ˜¯ï¼š</font>

```javascript
const queue = (hook.queue = {
  // ä¸æç®€å®ç°ä¸­çš„åŒåå­—æ®µæ„ä¹‰ç›¸åŒï¼Œä¿å­˜updateå¯¹è±¡
  pending: null,
  // ä¿å­˜dispatchAction.bind()çš„å€¼
  dispatch: null,
  // ä¸Šä¸€æ¬¡renderæ—¶ä½¿ç”¨çš„reducer
  lastRenderedReducer: reducer,
  // ä¸Šä¸€æ¬¡renderæ—¶çš„state
  lastRenderedState: (initialState: any),
});
```

<font style="color:rgb(44, 62, 80);">ä¸åŒçš„æ˜¯ ä»–ä»¬çš„ </font><font style="color:rgb(71, 101, 130);">lastRenderedReducer å‚æ•°ä¸ä¸€æ ·ã€‚</font>

<font style="color:rgb(71, 101, 130);">useState æ˜¯æœ‰ä¸€ä¸ªé»˜è®¤çš„ basicStateReducerï¼ŒuseReducer æ˜¯ä¼ å…¥çš„ reducerï¼Œä½†.... basicStateReducer å¥½åƒæŒºç®€å•çš„</font>

```typescript
function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {
  return typeof action === 'function' ? action(state) : action;
}
```

<font style="color:rgb(44, 62, 80);">ä»æºç æ¥çœ‹ å¯ä»¥å°è¯ </font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(44, 62, 80);">åªæ˜¯é¢„ç½®äº†</font><font style="color:rgb(71, 101, 130);">reducer</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">useReducer</font><font style="color:rgb(44, 62, 80);">ã€‚ </font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">updateæ—¶ï¼š</font>

<font style="color:rgb(71, 101, 130);">useReducer</font><font style="color:rgb(44, 62, 80);">ä¸</font><font style="color:rgb(71, 101, 130);">useState</font><font style="color:rgb(44, 62, 80);">è°ƒç”¨çš„åˆ™æ˜¯åŒä¸€ä¸ªå‡½æ•°</font>[<font style="color:rgb(44, 62, 80);">updateReducer</font>](https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L665)

```javascript
function updateReducer<S, I, A>(
  reducer: (S, A) => S,
  initialArg: I,
  init?: (I) => S
): [S, Dispatch<A>] {
  // è·å–å½“å‰hook
  const hook = updateWorkInProgressHook();
  const queue = hook.queue;

  queue.lastRenderedReducer = reducer;

  // ...åŒupdateä¸updateQueueç±»ä¼¼çš„æ›´æ–°é€»è¾‘

  const dispatch: Dispatch<A> = (queue.dispatch: any);
  return [hook.memoizedState, dispatch];
}
```

<font style="color:rgb(44, 62, 80);">è¿™ä¸ªé˜¶æ®µä¸»è¦çš„ä½œç”¨å°±æ˜¯ :æ‰¾åˆ°ä¸ä¹‹å¯¹äºçš„hook ç„¶åä¾æ®updateè®¡ç®—è¯¥hook çš„æ–°state è¿›è¡Œä¸€ä¸ªè¿”å›.</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">mountçš„æ—¶å€™ æ˜¯æ‰§è¡Œçš„ReactDOM.render æˆ–ç›¸å…³åˆå§‹åŒ–APIäº§ç”Ÿçš„æ›´æ–° åªä¼šæ‰§è¡Œä¸€æ¬¡</font>

<font style="color:rgb(44, 62, 80);">updateæ˜¯åœ¨äº‹ä»¶/å‰¯ä½œç”¨/renderé˜¶æ®µäº§ç”Ÿçš„æ›´æ–°ï¼Œä¸ºé¿å…æ— é™å¾ªç¯ éœ€è¦åŒºåˆ«å¯¹å¾…</font>

<font style="color:rgb(44, 62, 80);">åŸºäºä¸Šé¢ä¸¤ä¸ªåŸå›  mountæ˜¯ä½¿ç”¨çš„æ˜¯hookæ˜¯ mountWorkInProgressHookï¼Œupdateçš„ä½¿ç”¨çš„æ˜¯updateWorkInProgressHook.</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">æ¥ä¸‹é‡Œæˆ‘ä»¬è¿›å…¥è°ƒç”¨é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µ æ€»ç»“ä¸ºï¼š</font>

<font style="color:rgb(153, 153, 153);">åˆ›å»º</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(153, 153, 153);">ï¼Œå°†</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(153, 153, 153);">åŠ å…¥</font><font style="color:rgb(71, 101, 130);">queue.pending</font><font style="color:rgb(153, 153, 153);">ä¸­ï¼Œå¹¶å¼€å¯è°ƒåº¦ã€‚</font>

<font style="color:rgb(153, 153, 153);"></font>

<font style="color:rgb(153, 153, 153);">è°ƒç”¨é˜¶æ®µä¼šæ‰§è¡ŒdispactAction æ­¤æ—¶FunctionComponnet å¯¹åº”çš„fiber ä»¥åŠhook.queue è°ƒç”¨bindæ–¹æ³•é¢„å…ˆä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</font>

<font style="color:rgb(153, 153, 153);"></font>

<font style="color:rgb(71, 101, 130);">æˆ‘ä»¬é€šå¸¸äººç‰© useReducer(reducer, initialState)</font><font style="color:rgb(44, 62, 80);">çš„ä¼ å‚ä¸ºåˆå§‹åŒ–å‚æ•°ï¼Œåœ¨ä»¥åçš„è°ƒç”¨ä¸­éƒ½ä¸å¯å˜ã€‚</font>

<font style="color:rgb(44, 62, 80);">ä½†å®é™…æƒ…å†µä¸­ åœ¨</font><font style="color:rgb(71, 101, 130);">updateReducer</font><font style="color:rgb(44, 62, 80);">æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°</font><font style="color:rgb(71, 101, 130);">lastRenderedReducer</font><font style="color:rgb(44, 62, 80);">åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šé‡æ–°èµ‹å€¼ã€‚</font>

## useEffect
è¿™ä¸ªhookåœ¨ commité˜¶æ®µè¿›è¡Œï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªfunction <font style="color:rgb(71, 101, 130);">flushPassiveEffectsçš„è°ƒç”¨</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">è¿™ä¸ªfunctionä¼šå¹²ä¸‰ä¸ªäº‹æƒ…ï¼ˆæˆ‘ä»¬å…³æ³¨å‰ä¸¤ä¸ªï¼‰</font>

+ <font style="color:rgb(44, 62, 80);">è°ƒç”¨è¯¥</font><font style="color:rgb(71, 101, 130);">useEffect</font><font style="color:rgb(44, 62, 80);">åœ¨ä¸Šä¸€æ¬¡</font><font style="color:rgb(71, 101, 130);">render</font><font style="color:rgb(44, 62, 80);">æ—¶çš„é”€æ¯å‡½æ•°</font>
+ <font style="color:rgb(44, 62, 80);">è°ƒç”¨è¯¥</font><font style="color:rgb(71, 101, 130);">useEffect</font><font style="color:rgb(44, 62, 80);">åœ¨æœ¬æ¬¡</font><font style="color:rgb(71, 101, 130);">render</font><font style="color:rgb(44, 62, 80);">æ—¶çš„å›è°ƒå‡½æ•°</font>
+ <font style="color:rgb(44, 62, 80);">å¦‚æœå­˜åœ¨åŒæ­¥ä»»åŠ¡ï¼Œä¸éœ€è¦ç­‰å¾…ä¸‹æ¬¡</font><font style="color:rgb(71, 101, 130);">äº‹ä»¶å¾ªç¯</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">å®ä»»åŠ¡</font><font style="color:rgb(44, 62, 80);">ï¼Œæå‰æ‰§è¡Œä»–</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ªäº‹æƒ… ï¼šè°ƒç”¨ä¸Šæ¬¡çš„é”€æ¯å‡½æ•°</font>

<font style="color:rgb(71, 101, 130);">useEffect</font><font style="color:rgb(44, 62, 80);">çš„æ‰§è¡Œéœ€è¦ä¿è¯æ‰€æœ‰ç»„ä»¶</font><font style="color:rgb(71, 101, 130);">useEffect</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">é”€æ¯å‡½æ•°</font><font style="color:rgb(44, 62, 80);">å¿…é¡»éƒ½æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œä»»æ„ä¸€ä¸ªç»„ä»¶çš„</font><font style="color:rgb(71, 101, 130);">useEffect</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">å›è°ƒå‡½æ•°</font><font style="color:rgb(44, 62, 80);">ã€‚</font>

```javascript
// pendingPassiveHookEffectsUnmountä¸­ä¿å­˜äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œé”€æ¯çš„useEffect
const unmountEffects = pendingPassiveHookEffectsUnmount;
  pendingPassiveHookEffectsUnmount = [];
  for (let i = 0; i < unmountEffects.length; i += 2) {
    const effect = ((unmountEffects[i]: any): HookEffect);
    const fiber = ((unmountEffects[i + 1]: any): Fiber);
    const destroy = effect.destroy;
    effect.destroy = undefined;

    if (typeof destroy === 'function') {
      // é”€æ¯å‡½æ•°å­˜åœ¨åˆ™æ‰§è¡Œ
      try {
        destroy();
      } catch (error) {
        captureCommitPhaseError(fiber, error);
      }
    }
  }	

// å‘pendingPassiveHookEffectsUnmountæ•°ç»„å†…pushæ•°æ®çš„æ“ä½œå‘ç”Ÿåœ¨layout
// é˜¶æ®µ commitLayoutEffectOnFiberæ–¹æ³•å†…éƒ¨çš„schedulePassiveEffectsæ–¹æ³•ä¸­ã€‚

function schedulePassiveEffects(finishedWork: Fiber) {
  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);
  const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;
  if (lastEffect !== null) {
    const firstEffect = lastEffect.next;
    let effect = firstEffect;
    do {
      const {next, tag} = effect;
      if (
        (tag & HookPassive) !== NoHookEffect &&
        (tag & HookHasEffect) !== NoHookEffect
      ) {
        // å‘`pendingPassiveHookEffectsUnmount`æ•°ç»„å†…`push`è¦é”€æ¯çš„effect
        enqueuePendingPassiveHookEffectUnmount(finishedWork, effect);
        // å‘`pendingPassiveHookEffectsMount`æ•°ç»„å†…`push`è¦æ‰§è¡Œå›è°ƒçš„effect
        enqueuePendingPassiveHookEffectMount(finishedWork, effect);
      }
      effect = next;
    } while (effect !== firstEffect);
  }
}
```

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">å†çœ‹ç¬¬äºŒä¸ªäº‹æƒ…ï¼šè°ƒç”¨æœ¬æ¬¡æ³¨å†Œçš„callback</font>

ä¸é˜¶æ®µä¸€ç±»ä¼¼ ä¹Ÿæ˜¯éå†å’ŒæŒ‡å‘effect çš„å›è°ƒï¼Œ<font style="color:rgb(44, 62, 80);">å…¶ä¸­å‘</font><font style="color:rgb(71, 101, 130);">pendingPassiveHookEffectsMount</font><font style="color:rgb(44, 62, 80);">ä¸­</font><font style="color:rgb(71, 101, 130);">push</font><font style="color:rgb(44, 62, 80);">æ•°æ®çš„æ“ä½œåŒæ ·å‘ç”Ÿåœ¨</font><font style="color:rgb(71, 101, 130);">schedulePassiveEffects</font><font style="color:rgb(44, 62, 80);">ä¸­ã€‚</font>

```javascript
// pendingPassiveHookEffectsMountä¸­ä¿å­˜äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œå›è°ƒçš„useEffect
const mountEffects = pendingPassiveHookEffectsMount;
pendingPassiveHookEffectsMount = [];
for (let i = 0; i < mountEffects.length; i += 2) {
  const effect = ((mountEffects[i]: any): HookEffect);
  const fiber = ((mountEffects[i + 1]: any): Fiber);
  
  try {
    const create = effect.create;
   effect.destroy = create();
  } catch (error) {
    captureCommitPhaseError(fiber, error);
  }
}
```

## useRef
refæœ‰ä¸¤ç§ç±»å‹ï¼ˆå®é™…ä¸Šè¿˜æœ‰ä¸€ç§ç±»å‹string ä½†æ˜¯æ–°ç‰ˆæœ¬ä¸­å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸è®²äº†ï¼‰ï¼Œè¿™ä¸¤ç§ç±»å‹æ˜¯ function/ { current: any }, useRef å®é™…ä¸Šå°±æ˜¯ç¬¬äºŒç§ç±»å‹



ä¸å…¶ä»–hookä¸€æ ·ï¼Œå®ƒä¹Ÿåˆ†mount å’Œ update ä¿å­˜äº†ä¸¤ä¸ªä¸åŒçš„ <font style="color:rgb(71, 101, 130);">dispatcherï¼ŒåŒºåˆ«å°±æ˜¯ é»˜è®¤èµ‹å€¼ ï¼Œä¸€ä¸ªæ˜¯ç›´æ¥è·å–å€¼ã€‚</font>

åœ¨Reactä¸­ <font style="color:rgb(71, 101, 130);">HostComponent</font><font style="color:rgb(44, 62, 80);">ã€</font><font style="color:rgb(71, 101, 130);">ClassComponent</font><font style="color:rgb(44, 62, 80);">ã€</font><font style="color:rgb(71, 101, 130);">ForwardRefï¼ˆè¿™ä¸ªä¸ä¼šè¿›å…¥refæµç¨‹ å®ƒåªæ˜¯ä¼ é€’å€¼ä¸‹å»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å…³æ³¨ï¼‰</font><font style="color:rgb(44, 62, 80);">å¯ä»¥èµ‹å€¼</font><font style="color:rgb(71, 101, 130);">ref</font><font style="color:rgb(44, 62, 80);">å±æ€§ã€‚</font>

<font style="color:rgb(71, 101, 130);">HostComponent</font><font style="color:rgb(44, 62, 80);">åœ¨</font><font style="color:rgb(71, 101, 130);">commité˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">mutationå­é˜¶æ®µ</font><font style="color:rgb(44, 62, 80);">æ‰§è¡Œ</font><font style="color:rgb(71, 101, 130);">DOM</font><font style="color:rgb(44, 62, 80);">æ“ä½œï¼ˆæ‰§è¡Œçš„ä¾æ®å°±æ˜¯effectTagï¼‰ClassComponnet å¦‚æœä¹ŸåŒ…å«ref é‚£ä¹ˆä»–ä»¬ä¹Ÿä¼šè¢«æ‰“ä¸Šå¯¹äºçš„effectTagæ“ä½œã€‚</font>

é‚£ä¹ˆ æˆ‘ä»¬å°±äº†è§£äº†ï¼šRef çš„å·¥ä½œå¯ä»¥åˆ†ä¸¤ä¸ªéƒ¨åˆ† 

1. renderé˜¶æ®µ <font style="color:rgb(44, 62, 80);">ä¸ºå«æœ‰</font><font style="color:rgb(71, 101, 130);">ref</font><font style="color:rgb(44, 62, 80);">å±æ€§çš„</font><font style="color:rgb(71, 101, 130);">fiber</font><font style="color:rgb(44, 62, 80);">æ·»åŠ </font><font style="color:rgb(71, 101, 130);">Ref effectTag</font>
2. commit é˜¶æ®µ <font style="color:rgb(44, 62, 80);">ä¸ºåŒ…å«</font><font style="color:rgb(71, 101, 130);">Ref effectTag</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">fiber</font><font style="color:rgb(44, 62, 80);">æ‰§è¡Œå¯¹åº”æ“ä½œ</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">renderé˜¶æ®µ</font>

<font style="color:rgb(44, 62, 80);">ä¸»è¦çš„äº‹æƒ…å‘ç”Ÿå’‹ beginWork ä¸ completeWorkä¸­ï¼Œä»–ä»¬é‡Œé¢éƒ½ä¼šè°ƒç”¨ markRefæ–¹æ³•ã€‚</font>

<font style="color:rgb(44, 62, 80);">ä¸‹é¢æ˜¯ä¸€äº›åˆ¤æ–­ï¼Œç¬¦åˆå¦‚ä¸‹æ¡ä»¶çš„ fiber ä¼šè¢«èµ‹å€¼ä¸ŠRef effectTag ä»¥æ”¯æŒåç»­çš„å·¥ä½œæµç¨‹</font>

+ <font style="color:rgb(71, 101, 130);">fiber</font><font style="color:rgb(44, 62, 80);">ç±»å‹ä¸º</font><font style="color:rgb(71, 101, 130);">HostComponent</font><font style="color:rgb(44, 62, 80);">ã€</font><font style="color:rgb(71, 101, 130);">ClassComponent</font><font style="color:rgb(44, 62, 80);">ã€</font><font style="color:rgb(71, 101, 130);">ScopeComponent</font><font style="color:rgb(44, 62, 80);">ï¼ˆè¿™ç§æƒ…å†µæˆ‘ä»¬ä¸è®¨è®ºï¼‰</font>
+ <font style="color:rgb(44, 62, 80);">å¯¹äº</font><font style="color:rgb(71, 101, 130);">mount</font><font style="color:rgb(44, 62, 80);">ï¼Œ</font><font style="color:rgb(71, 101, 130);">workInProgress.ref !== null</font><font style="color:rgb(44, 62, 80);">ï¼Œå³å­˜åœ¨</font><font style="color:rgb(71, 101, 130);">ref</font><font style="color:rgb(44, 62, 80);">å±æ€§</font>
+ <font style="color:rgb(44, 62, 80);">å¯¹äº</font><font style="color:rgb(71, 101, 130);">update</font><font style="color:rgb(44, 62, 80);">ï¼Œ</font><font style="color:rgb(71, 101, 130);">current.ref !== workInProgress.ref</font><font style="color:rgb(44, 62, 80);">ï¼Œå³</font><font style="color:rgb(71, 101, 130);">ref</font><font style="color:rgb(44, 62, 80);">å±æ€§æ”¹å˜</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">commité˜¶æ®µ</font>

<font style="color:rgb(44, 62, 80);">å†å…·ä½“ç‚¹ å®ƒå‘ç”Ÿäº† </font><font style="color:rgb(71, 101, 130);">mutation å­é˜¶æ®µã€‚</font>

å¯¹äºrefå˜åŒ–çš„æƒ…å†µ ï¼Œéœ€è¦å…ˆç§»é™¤ä¹‹å‰å­˜åœ¨çš„refã€‚

ç„¶åå†è¿›å…¥Refèµ‹å€¼é˜¶æ®µ(Layouté˜¶æ®µ)  è°ƒç”¨ commitLayoutEffectä¼šæ‰§è¡ŒcommitAttachRefï¼ˆèµ‹å€¼refï¼‰

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">useEffect åœ¨æºç ä¸Š å®é™…ä¸Šå°±åœ¨è°ƒåº¦ä¸­å¯¹åº”çš„ schedulePassiveEffecct functionçš„è°ƒç”¨  
</font><font style="color:rgb(44, 62, 80);"> </font>

## useMemoå’ŒuseCallback
æˆ‘ä»¬è¿˜æ˜¯ä»¥Mount å’ŒUpdate çš„ä¸¤ä¸ªä¸åŒçš„åœºæ™¯ æ¥åˆ†åˆ«åˆ†æä»–ä»¬

```typescript
function mountMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null,
): T {
  // åˆ›å»ºå¹¶è¿”å›å½“å‰hook
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  // è®¡ç®—value
  const nextValue = nextCreate();
  // å°†valueä¸depsä¿å­˜åœ¨hook.memoizedState
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}

function mountCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // åˆ›å»ºå¹¶è¿”å›å½“å‰hook
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  // å°†valueä¸depsä¿å­˜åœ¨hook.memoizedState
  hook.memoizedState = [callback, nextDeps];
  return callback;
}
// è¿™ä¸¤ä¸ªåŒºåˆ«å°±æ˜¯ æ˜¯å¦ä¼šè°ƒç”¨nextCreate å›è°ƒå‡½æ•° ç„¶åæ‹¿å€¼ä½œä¸º value ä¿å­˜ 
```

```typescript
function updateMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null,
): T {
  // è¿”å›å½“å‰hook
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  const prevState = hook.memoizedState;

  if (prevState !== null) {
    if (nextDeps !== null) {
      const prevDeps: Array<mixed> | null = prevState[1];
      // åˆ¤æ–­updateå‰åvalueæ˜¯å¦å˜åŒ–
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        // æœªå˜åŒ–
        return prevState[0];
      }
    }
  }
  // å˜åŒ–ï¼Œé‡æ–°è®¡ç®—value
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}

function updateCallback<T>(callback: T, deps: Array<mixed> | void | null): T {
  // è¿”å›å½“å‰hook
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  const prevState = hook.memoizedState;

  if (prevState !== null) {
    if (nextDeps !== null) {
      const prevDeps: Array<mixed> | null = prevState[1];
      // åˆ¤æ–­updateå‰åvalueæ˜¯å¦å˜åŒ–
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        // æœªå˜åŒ–
        return prevState[0];
      }
    }
  }

  // å˜åŒ–ï¼Œå°†æ–°çš„callbackä½œä¸ºvalue
  hook.memoizedState = [callback, nextDeps];
  return callback;
}

// è¿™ä¸¤ä¸ªå”¯ä¸€çš„åŒºåˆ«ä¹Ÿæ˜¯ â€œå›è°ƒå‡½æ•°æœ¬èº«è¿˜æ˜¯å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœä½œä¸ºvalueã€‚â€

```

# å¹¶å‘æ›´æ–°æ¨¡å¼Concurrent Mdode
> ä»è¿™é‡Œå¼€å§‹ï¼Œæœ‰éƒ¨åˆ†å†…å®¹ ä¸èƒ½é€šè¿‡ é˜…è¯»æ–‡æ¡£æ¥å®Œæˆï¼Œéœ€è¦å»è§†é¢‘è¯¾çœ‹ï¼Œå±äºæ˜¯ä»˜è´¹å†…å®¹äº†ï¼Œå€’ä¹Ÿæ˜¯èƒ½å¤Ÿç†è§£ï¼Œæ¯•ç«Ÿäººæ˜¯è¦ç”Ÿå­˜çš„ï¼Œåƒç›¸ä¸éš¾çœ‹æˆ‘èƒ½å¤Ÿæ¥å—ã€‚ï¼ˆ<font style="color:rgb(44, 62, 80);">å®ç°å¼‚æ­¥å¯ä¸­æ–­çš„æ›´æ–°</font>ï¼‰
>



<font style="color:rgb(71, 101, 130);">Fiber</font><font style="color:rgb(44, 62, 80);">æ¶æ„çš„æ„ä¹‰åœ¨äºï¼Œä»–å°†å•ä¸ª</font><font style="color:rgb(71, 101, 130);">ç»„ä»¶</font><font style="color:rgb(44, 62, 80);">ä½œä¸º</font><font style="color:rgb(71, 101, 130);">å·¥ä½œå•å…ƒ</font><font style="color:rgb(44, 62, 80);">ï¼Œä½¿ä»¥</font><font style="color:rgb(71, 101, 130);">ç»„ä»¶</font><font style="color:rgb(44, 62, 80);">ä¸ºç²’åº¦çš„â€œå¼‚æ­¥å¯ä¸­æ–­çš„æ›´æ–°â€æˆä¸ºå¯èƒ½ã€‚</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">ä»¬é…åˆ</font><font style="color:rgb(71, 101, 130);">æ—¶é—´åˆ‡ç‰‡</font><font style="color:rgb(44, 62, 80);">ï¼Œå°±èƒ½æ ¹æ®å®¿ä¸»ç¯å¢ƒæ€§èƒ½ï¼Œä¸ºæ¯ä¸ª</font><font style="color:rgb(71, 101, 130);">å·¥ä½œå•å…ƒ</font><font style="color:rgb(44, 62, 80);">åˆ†é…ä¸€ä¸ª</font><font style="color:rgb(71, 101, 130);">å¯è¿è¡Œæ—¶é—´</font><font style="color:rgb(44, 62, 80);">ï¼Œå®ç°â€œå¼‚æ­¥å¯ä¸­æ–­çš„æ›´æ–°â€ã€‚</font>

<font style="color:rgb(44, 62, 80);">äºæ˜¯ï¼Œ</font>[<font style="color:rgb(44, 62, 80);">scheduler(opens new window)</font>](https://github.com/facebook/react/tree/master/packages/scheduler)<font style="color:rgb(44, 62, 80);">ï¼ˆè°ƒåº¦å™¨ï¼‰äº§ç”Ÿäº†ã€‚</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">laneæ¨¡å‹çš„åŠ å…¥ å¯ä»¥æ˜ç¡® æ›´æ–°çš„ä¼˜å…ˆçº§ ä»è€Œæé«˜æ€§èƒ½ã€‚3</font>

<font style="color:rgb(44, 62, 80);">ä»æºç ä¸Šè®²ï¼š</font><font style="color:rgb(153, 153, 153);">Concurrent Modeæ˜¯ä¸€å¥— *å¯æ§çš„â€œå¤šä¼˜å…ˆçº§æ›´æ–°æ¶æ„â€ã€‚*</font>

å…·ä½“çš„ä¸Šå±‚APIçš„è¡¨ç°ä¸Šï¼šbatchedUpdate & Suspense & useDeferredValue

## <font style="color:rgb(153, 153, 153);">å…³äºæ—¶é—´åˆ‡ç‰‡</font>
schedulerè¿™ä¸ªpackage ä¸Šç‹¬ç«‹React ä¹‹å¤–å­˜åœ¨çš„ï¼Œå®ƒçš„ä¼˜å…ˆçº§ å’ŒReactä¸­çš„ä¼˜å…ˆçº§å¹¶ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè¿™ç‚¹ä½ éœ€è¦äº†è§£æ¸…æ¥šã€‚



**<font style="color:#DF2A3F;">scheudlerä¸»è¦çš„å·¥ä½œæœ‰ä¸¤ä¸ªæ–¹é¢ï¼š æ—¶é—´åˆ‡ç‰‡/ ä¼˜å…ˆçº§è°ƒåº¦ã€‚</font>**



å…³äºæ—¶é—´åˆ‡ç‰‡çš„æœ¬è´¨æ˜¯æ¨¡æ‹Ÿ requestdleCallback ã€‚

```plain
ä¸€ä¸ªtask(å®ä»»åŠ¡) -- é˜Ÿåˆ—ä¸­å…¨éƒ¨job(å¾®ä»»åŠ¡) -- requestAnimationFrame -- æµè§ˆå™¨é‡æ’/é‡ç»˜ -- requestIdleCallback
```

å”¯ä¸€èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶è°ƒç”¨æ—¶æœºçš„æ˜¯APIæ˜¯<font style="color:rgb(71, 101, 130);">requestAnimationFrameï¼Œä»–èƒ½å¤Ÿåœ¨æ¸²æŸ“ä¹‹å‰è°ƒç”¨ã€‚</font>

é€€è€Œæ±‚å…¶æ¬¡ schedulerçš„ æ—¶é—´åˆ‡ç‰‡æ˜¯é€šè¿‡taskå®Œæˆçš„ï¼ˆMessageChannle API æ¯” setTime æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæ‰€ä»¥åœ¨åº•å±‚çš„å®ç°æ˜¯ èƒ½ç”¨ å‰è€…ç”¨å‰è€…ä¸è¡Œå°±ç”¨setTImeOutï¼‰



å‰æ–‡ä¸­æåˆ°è¿‡ reactçš„renderé˜¶æ®µ å¼€å¯concurrent mode éå†å‰ å›æœ‰ä¸€ä¸ªshouYeildåˆ¤æ–­ï¼Œçœ‹çœ‹æ˜¯å¦è¦ä¸­æ–­ ä½¿æµè§ˆå™¨æœ‰æ—¶é—´æ¸²æŸ“ã€‚

```typescript
function workLoopConcurrent() {
  // Perform work until Scheduler asks us to yield
  while (workInProgress !== null && !shouldYield()) {
    performUnitOfWork(workInProgress);
  }
}
```

åœ¨Scheulderé»˜è®¤ç»™æ¯ä¸€ä¸ªtaskåˆ†é…çš„æ—¶é—´æ˜¯5ms



æ¥ä¸‹æ¥æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹ <font style="color:rgb(71, 101, 130);">performUnitOfWork</font><font style="color:rgb(44, 62, 80);">è¢«ä¸­æ–­åæ˜¯å¦‚ä½•é‡æ–°å¯åŠ¨çš„ã€‚</font>

<font style="color:rgb(71, 101, 130);">Scheduler</font><font style="color:rgb(44, 62, 80);">å¯¹å¤–æš´éœ²äº†ä¸€ä¸ªæ–¹æ³•</font>[unstable_runWithPriority](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/Scheduler.js#L217-L237)

<font style="color:rgb(44, 62, 80);">è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ª</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">ä¸ä¸€ä¸ª</font><font style="color:rgb(71, 101, 130);">å›è°ƒå‡½æ•°</font><font style="color:rgb(44, 62, 80);">ï¼Œåœ¨</font><font style="color:rgb(71, 101, 130);">å›è°ƒå‡½æ•°</font><font style="color:rgb(44, 62, 80);">å†…éƒ¨è°ƒç”¨è·å–</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">çš„æ–¹æ³•éƒ½ä¼šå–å¾—ç¬¬ä¸€ä¸ªå‚æ•°å¯¹åº”çš„</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">ï¼Œæœ‰äº”ç§ä¼˜å…ˆçº§ï¼Œåœ¨reactä¸­å‡¡æ¶‰åŠåˆ° ä¼˜å…ˆçº§çš„æ—¶å€™ éƒ½ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</font>

<font style="color:rgb(44, 62, 80);">comitæ˜¯æ¸²æŸ“çš„èµ·ç‚¹åœ¨comitRootä¸­ ä¼ é€’çš„æ˜¯ </font><font style="color:rgb(71, 101, 130);">ImmediateSchedulerPriority</font><font style="color:rgb(44, 62, 80);">å³</font><font style="color:rgb(71, 101, 130);">ImmediatePriority</font><font style="color:rgb(44, 62, 80);">çš„åˆ«åï¼Œä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œä¼šç«‹å³æ‰§è¡Œã€‚</font>

<font style="color:rgb(44, 62, 80);">é™¤æ­¤å¤– shecduler è¿˜æš´éœ²ä¸€ä¸ªAPI unstable_schedulerCallback ï¼Œè¿™ä¸ªæ–¹æ³•å›åœ¨ ä¼˜å…ˆçº§ ä¸­æ³¨å†Œå›æ‰å‡½æ•°ã€‚æ¯”å¦‚commité˜¶æ®µçš„beforMuationæ—¶çš„useEffect å›æ‰</font>

```typescript
if (!rootDoesHavePassiveEffects) {
  rootDoesHavePassiveEffects = true;
  scheduleCallback(NormalSchedulerPriority, () => {
    flushPassiveEffects();
    return null;
  });
}
```

<font style="color:rgb(44, 62, 80);">ä¸åŒ</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">æ„å‘³ç€ä¸åŒæ—¶é•¿çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´ï¼š</font>

<font style="color:rgb(44, 62, 80);">å¦‚æœä¸€ä¸ªtaskçš„ä¼˜å…ˆçº§æ˜¯ Immediataçš„ é‚£ä¹ˆå¯¹äºçš„å€¼ = -1 ï¼Œæ‰€ä»¥æœ‰ä¸‹é¢çš„æƒ…å†µå‘ç”Ÿ</font>

```tsx
var expirationTime = startTime - 1;
```

<font style="color:rgb(44, 62, 80);">åˆ™è¯¥ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´æ¯”å½“å‰æ—¶é—´è¿˜çŸ­ï¼Œè¡¨ç¤ºä»–å·²ç»è¿‡æœŸäº†ï¼Œéœ€è¦ç«‹å³è¢«æ‰§è¡Œã€‚</font>



åœ¨reactä¸­ å­˜åœ¨è®¸å¤šçš„ä¼˜å…ˆçº§ taskï¼Œè¿™äº›ä»»åŠ¡åˆ†ä¸¤ç±» ï¼šå·²å‡†å¤‡å°±ç»ªçš„ / æœªå‡†å¤‡å°±ç»ªçš„ï¼Œå®ƒä»¬éƒ½ä¿æŒåœ¨scheudleré‡Œ

+ <font style="color:rgb(44, 62, 80);">timerQueueï¼šä¿å­˜æœªå°±ç»ªä»»åŠ¡</font>
+ <font style="color:rgb(44, 62, 80);">taskQueueï¼šä¿å­˜å·²å°±ç»ªä»»åŠ¡</font>

<font style="color:rgb(44, 62, 80);">å…·ä½“çš„è°ƒç”¨æ—¶æœºæ˜¯é€šè¿‡â€œå°å †æ ˆâ€å®ç°çš„ã€‚</font>

## Laneæ¨¡å‹
åœ¨Reactä¸­ä¼šæœ‰æ¯”schedulerä¸­æ›´å¤šçš„æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥å®ƒéœ€è¦æ›´å¤šçš„è®¾è®¡â€œä¼˜å…ˆçº§â€ ï¼Œéœ€è¦æ»¡è¶³ä¸‹é¢çš„è¦æ±‚

+ <font style="color:rgb(44, 62, 80);">å¯ä»¥è¡¨ç¤º</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">çš„ä¸åŒ</font>
+ <font style="color:rgb(44, 62, 80);">å¯èƒ½åŒæ—¶å­˜åœ¨å‡ ä¸ªåŒ</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">æ›´æ–°</font><font style="color:rgb(44, 62, 80);">ï¼Œæ‰€ä»¥è¿˜å¾—èƒ½è¡¨ç¤º</font><font style="color:rgb(71, 101, 130);">æ‰¹</font><font style="color:rgb(44, 62, 80);">çš„æ¦‚å¿µ</font>
+ <font style="color:rgb(44, 62, 80);">æ–¹ä¾¿è¿›è¡Œ</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">ç›¸å…³è®¡ç®—</font>

<font style="color:rgb(44, 62, 80);">å¯¹äºè¡¨ç¤ºä¼˜å…ˆçº§çš„ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥ç±»æ¯” èµ›è½¦åœº ä¸åŒçš„èµ›é“æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€‚</font><font style="color:rgb(71, 101, 130);">lane</font><font style="color:rgb(44, 62, 80);">æ¨¡å‹å€Ÿé‰´äº†åŒæ ·çš„æ¦‚å¿µï¼Œä½¿ç”¨31ä½çš„äºŒè¿›åˆ¶è¡¨ç¤º31æ¡èµ›é“ï¼Œä½æ•°è¶Šå°çš„èµ›é“</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">è¶Šé«˜ï¼ŒæŸäº›ç›¸é‚»çš„èµ›é“æ‹¥æœ‰ç›¸åŒ</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">ã€‚</font>

<font style="color:rgb(44, 62, 80);"></font>

<font style="color:rgb(44, 62, 80);">æ‰¹çš„æ¦‚å¿µï¼ˆå‡ ä¸ªå˜é‡å ç”¨äº†å‡ æ¡èµ›é“ è¿™å°±æ˜¯æ‰¹ï¼‰ å¯ä»¥è¢«ç§°ä¸ºlanes è¶Šä½</font><font style="color:rgb(71, 101, 130);">ä¼˜å…ˆçº§</font><font style="color:rgb(44, 62, 80);">çš„</font><font style="color:rgb(71, 101, 130);">æ›´æ–°</font><font style="color:rgb(44, 62, 80);">è¶Šå®¹æ˜“è¢«æ‰“æ–­ï¼Œå¯¼è‡´ç§¯å‹ä¸‹æ¥ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„ä½ã€‚ç›¸åï¼Œæœ€é«˜ä¼˜çš„åŒæ­¥æ›´æ–°çš„</font><font style="color:rgb(71, 101, 130);">SyncLane</font><font style="color:rgb(44, 62, 80);">ä¸éœ€è¦å¤šä½™çš„</font><font style="color:rgb(71, 101, 130);">lanes</font>

<font style="color:rgb(71, 101, 130);"></font>

<font style="color:rgb(71, 101, 130);">å…³äºè®¡ç®—çš„è¯ reactä½¿ç”¨çš„äºŒè¿›åˆ¶çš„æ•°æ®è¡¨ç¤º æ‰€ä»¥è®¡ç®—ä¹Ÿç›¸å¯¹ç®€å• ç›´æ¥ä½è¿ç®— å°±å®Œäº‹äº†ã€‚</font>

<font style="color:rgb(44, 62, 80);">è¿™å°±æ˜¯</font><font style="color:rgb(71, 101, 130);">React</font><font style="color:rgb(44, 62, 80);">çš„ä¼˜å…ˆçº§æ¨¡å‹</font><font style="color:rgb(71, 101, 130);">lane</font><font style="color:rgb(44, 62, 80);">æ¨¡å‹ã€‚</font>



## å¼‚æ­¥çš„å¯ä¸­æ–­æ›´æ–°
ï¼ˆæœ‰æ·±åº¦ åç»­å†çœ‹ï¼‰



# React 18 çš„æ–°ç‰¹æ€§
> å‚è€ƒç´¢å¼•è§è¿™é‡Œï¼š[React18 æ–°ç‰¹æ€§è§£è¯» & å®Œæ•´ç‰ˆå‡çº§æŒ‡å— - æ˜é‡‘](https://juejin.cn/post/7094037148088664078)
>

æˆ‘ä»¬ä¸€ç›´éƒ½åœ¨æ˜¯ä½¿ç”¨Hooks ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´ä¸€ä¸‹  æ–°å¢äº†å‡ ä¸ªhooks.



React 18 æ”¾å¼ƒäº† IE11çš„æ”¯æŒï¼Œå¦‚æœä½ è¿˜éœ€è¦æ”¯æŒå®ƒ è¯·åˆ‡æ¢åˆ°React 17

## RenderAPI
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ å¹¶å‘æ›´æ–°çš„æ¨¡å‹äº† concurrent modeï¼ŒcreateReact(root).render ï¼Œ å»é™¤äº† Renderçš„å›è°ƒfunction è¿™æ˜¯ç”±äº**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">Suspense</font>** ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥é‡‡å–çš„å†³å®š

ssræ—¶çš„ <font style="color:rgb(56, 56, 56);">ï¼Œéœ€è¦æŠŠ</font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">hydration</font>**<font style="color:rgb(56, 56, 56);">å‡çº§ä¸º</font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">hydrateRoot</font>**

æœ€æ–°çš„typeScirpt æ”¯æŒä¸­ å¯¹äºchildren è¿™ä¸ªå±æ€§ éœ€è¦æ˜¾ç¤ºçš„å£°æ˜(17 å°±ä¸éœ€è¦ é»˜è®¤å°±å¸¦)

```typescript
// React 18
interface MyButtonProps {
  color: string;
  children?: React.ReactNode;
}
```

## setState
setState ç°åœ¨å¯ä»¥å®ç° å¤šä¸ªçŠ¶æ€çš„æ‰¹å¤„ç† ç„¶åä¸€æ¬¡æ€§renderäº†ã€‚

åœ¨17ä¸­ <font style="color:rgb(56, 56, 56);"> </font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">React äº‹ä»¶å¤„ç†å‡½æ•°</font>**<font style="color:rgb(56, 56, 56);"> ä¸­è¿›è¡Œæ‰¹å¤„ç†æ›´æ–°ï¼Œå…¶ä»–çš„æ˜¯ä¸ä¼šè¿›è¡Œæ‰¹å¤„ç†çš„ï¼Œè¿™å›å¯¼è‡´ç»„ä»¶è¿‡å¤šçš„renderï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¼šæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚ ä¸‹é¢çš„ä¾‹å­ä¼šæ¸²æŸ“ä¸¤æ¬¡</font>

```tsx
import React, { useState } from 'react';

// React 18
const App: React.FC = () => {
  console.log('Appç»„ä»¶æ¸²æŸ“äº†ï¼');
  const [count1, setCount1] = useState(0);
  const [count2, setCount2] = useState(0);
  return (
    <div
      onClick={async () => {
        await setCount1(count => count + 1);
        setCount2(count => count + 1);
      }}
    >
      <div>count1ï¼š {count1}</div>
      <div>count2ï¼š {count2}</div>
    </div>
  );
};

export default App;

```

## flushSync 
flushSyncå¯ä»¥è®©reacté€€å‡ºæ‰¹å¤„ç†æ›´æ–° ï¼Œ**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">flushSync</font>****<font style="color:rgb(56, 56, 56);"> å‡½æ•°å†…éƒ¨çš„å¤šä¸ª </font>****<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">setState</font>****<font style="color:rgb(56, 56, 56);"> ä»ç„¶ä¸ºæ‰¹é‡æ›´æ–°</font>**<font style="color:rgb(56, 56, 56);">ï¼Œè¿™æ ·å¯ä»¥ç²¾å‡†æ§åˆ¶å“ªäº›ä¸éœ€è¦çš„æ‰¹é‡æ›´æ–°ã€‚</font>

<font style="color:rgb(56, 56, 56);"></font>

<font style="color:rgb(56, 56, 56);">React18 åä½ è¿”å›çš„ç©ºç»„ä»¶ ä¸ä»…ä»…å¯ä»¥æ˜¯null è¿˜å¯ä»¥æ˜¯undefinedï¼Œåœ¨17ä¸­è¿”å›undefined ä¼šå¯¼è‡´æŠ¥é”™</font>

## <font style="color:rgb(56, 56, 56);">Suspense </font>
åœ¨ React 18 çš„ Suspense ç»„ä»¶ä¸­ï¼Œå®˜æ–¹å¯¹ ç©ºçš„fallback å±æ€§çš„å¤„ç†æ–¹å¼åšäº†æ”¹å˜ï¼šä¸å†è·³è¿‡ ç¼ºå¤±å€¼ æˆ– å€¼ä¸ºnull çš„ fallback çš„ Suspense è¾¹ç•Œã€‚ç›¸åï¼Œä¼šæ•è·è¾¹ç•Œå¹¶ä¸”å‘å¤–å±‚æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾ä¸åˆ°ï¼Œå°†ä¼šæŠŠ fallback å‘ˆç°ä¸º nullã€‚

```tsx
// React 18
const App = () => {
  return (
    <Suspense fallback={<Loading />}> // <--- ä¸ä½¿ç”¨, ä½†æ˜¯è‹¥åœ¨react 17 ä¸­é‚£ä¹ˆä¼šæ²¿ç”¨è¿™ä¸ª
      <Suspense>                      // <--- è¿™ä¸ªè¾¹ç•Œè¢«ä½¿ç”¨ï¼Œå°† fallback æ¸²æŸ“ä¸º null
        <Page />
      </Suspense>
    </Suspense>
  );
};

export default App;

```



## æ–°å¢API
useId hook

<font style="color:rgb(56, 56, 56);">æ”¯æŒåŒä¸€ä¸ªç»„ä»¶åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç”Ÿæˆç›¸åŒçš„å”¯ä¸€çš„ IDï¼Œé¿å… </font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">hydration</font>**<font style="color:rgb(56, 56, 56);"> çš„ä¸å…¼å®¹</font>

<font style="color:rgb(56, 56, 56);">å› ä¸ºæˆ‘ä»¬çš„æœåŠ¡å™¨æ¸²æŸ“æ—¶æä¾›çš„ </font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">HTML</font>**<font style="color:rgb(56, 56, 56);"> æ˜¯</font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">æ— åºçš„</font>**<font style="color:rgb(56, 56, 56);">ï¼Œ</font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">useId</font>**<font style="color:rgb(56, 56, 56);"> çš„åŸç†å°±æ˜¯æ¯ä¸ª </font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">id</font>**<font style="color:rgb(56, 56, 56);"> ä»£è¡¨è¯¥ç»„ä»¶åœ¨ç»„ä»¶æ ‘ä¸­çš„å±‚çº§ç»“æ„ã€‚</font>

<font style="color:rgb(56, 56, 56);"></font>

useSyncExternalStore Hook<font style="color:rgb(35, 39, 47);"> æ˜¯ä¸€ä¸ªè®©ä½ è®¢é˜…å¤–éƒ¨ store çš„ React Hookã€‚</font>

<font style="color:rgb(56, 56, 56);"> èƒ½å¤Ÿé€šè¿‡å¼ºåˆ¶åŒæ­¥æ›´æ–°æ•°æ®è®© React ç»„ä»¶åœ¨ CM ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–å¤–æ¥æ•°æ®æºã€‚ </font>

## <font style="color:rgb(56, 56, 56);">å¹¶å‘æ›´æ–°</font>
**<font style="color:rgb(153, 0, 0);background-color:rgb(248, 248, 248);">useTransition hookçš„ä½¿ç”¨ä¼š å¼•èµ·å¹¶å‘æ›´æ–°ï¼Œ</font>**

startTransitionï¼Œä¸»è¦ä¸ºäº†èƒ½åœ¨å¤§é‡çš„ä»»åŠ¡ä¸‹ä¹Ÿèƒ½ä¿æŒ UI å“åº”ã€‚è¿™ä¸ªæ–°çš„ API å¯ä»¥é€šè¿‡å°†ç‰¹å®šæ›´æ–°æ ‡è®°ä¸ºâ€œè¿‡æ¸¡â€æ¥æ˜¾è‘—æ”¹å–„ç”¨æˆ·äº¤äº’ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¢« startTransition å›è°ƒåŒ…è£¹çš„ setState è§¦å‘çš„æ¸²æŸ“è¢«æ ‡è®°ä¸º**ä¸ç´§æ€¥æ¸²æŸ“**ï¼Œè¿™äº›æ¸²æŸ“å¯èƒ½è¢«å…¶ä»–ç´§æ€¥æ¸²æŸ“æ‰€æŠ¢å ã€‚



ä¸ä¹‹ç±»ä¼¼çš„è¿˜æœ‰ä¸€ä¸ªhook å«åš **<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">useDeferredValue</font>**<font style="color:rgb(56, 56, 56);"> ï¼Œå¯ä»¥è®©ä¸€ä¸ª</font>**<font style="color:rgb(168, 98, 234);background-color:rgb(248, 245, 255);">state</font>**<font style="color:rgb(56, 56, 56);"> å»¶è¿Ÿç”Ÿæ•ˆï¼Œåªæœ‰å½“å‰æ²¡æœ‰ç´§æ€¥æ›´æ–°æ—¶ï¼Œè¯¥å€¼æ‰ä¼šå˜ä¸ºæœ€æ–°å€¼ã€‚</font>

<font style="color:rgb(56, 56, 56);">ä¸ useTransition çš„åŒºåˆ«å¦‚ä¸‹ï¼š</font>

+ <font style="color:rgb(56, 56, 56);">ç›¸åŒï¼š</font><font style="color:rgb(56, 56, 56);">useDeferredValue</font><font style="color:rgb(56, 56, 56);"> æœ¬è´¨ä¸Šå’Œå†…éƒ¨å®ç°ä¸ </font><font style="color:rgb(56, 56, 56);">useTransition</font><font style="color:rgb(56, 56, 56);"> ä¸€æ ·ï¼Œéƒ½æ˜¯æ ‡è®°æˆäº†</font><font style="color:rgb(56, 56, 56);">å»¶è¿Ÿæ›´æ–°</font><font style="color:rgb(56, 56, 56);">ä»»åŠ¡ã€‚</font>
+ <font style="color:rgb(56, 56, 56);">ä¸åŒï¼šuseTransition æ˜¯æŠŠæ›´æ–°ä»»åŠ¡å˜æˆäº†å»¶è¿Ÿæ›´æ–°ä»»åŠ¡ï¼Œè€Œ useDeferredValue æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„å€¼ï¼Œè¿™ä¸ªå€¼ä½œä¸ºå»¶æ—¶çŠ¶æ€ã€‚ï¼ˆä¸€ä¸ªç”¨æ¥åŒ…è£…æ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥åŒ…è£…å€¼ï¼‰</font>

