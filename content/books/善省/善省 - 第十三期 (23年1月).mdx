---
title: "å–„çœ - ç¬¬åä¸‰æœŸ (23å¹´1æœˆ)"
date: "2024-12-19"
summary: "æœ¬æœŸå†…å®¹åŒ…æ‹¬ï¼šRXJS Subjectå’ŒBehaviorScriptçš„ä½¿ç”¨é™·é˜±ä¸è§£å†³æ–¹æ¡ˆã€JavaScriptç©ºå€¼åˆå¹¶è¿ç®—ç¬¦(??)çš„æ³¨æ„äº‹é¡¹ã€React Native CodePush ERROR_CONFLICTé—®é¢˜è§£æåŠå¿«é€Ÿé›†æˆæ–¹æ¡ˆã€MobXçŠ¶æ€ç®¡ç†åœ¨çƒ­æ›´æ–°ä¸­çš„åº”ç”¨å®è·µã€‚"
status: ""
tech: ["RXJS","JavaScript","React Native","CodePush","MobX"]
github: "https://github.com/BM-laoli"
arxiv: ""
keyId: "å–„çœ"
---

> æ–°çš„ä¸€å¹´å¼€å§‹äº†ï¼Œè®°å½•ä¸‹ä½ é‡åˆ°çš„é—®é¢˜å’Œ çµæ„Ÿå§ï¼
>

# 
# RXJS Subject å’Œ BehaviorSubject
ä»Šå¹´é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯ç‰¹åˆ«å®¹æ˜“ä¸­æ‹›çš„åœ°æ–¹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„è¿™ä¸ªä»£ç ï¼Œä½ è§‰å¾—å®ƒæœ‰æ²¡æœ‰é—®é¢˜

```javascript
const $ChatSession = new Subject<{ sessionEnd: boolean }>();


useEffect( () => {
	const ws = new WebSokcet('xxx')
  ws.onMessage((e) => {
    switch (e.action) {
      case 1:
          $ChatSession.next({sessionEnd: ture})
        break;

        case 2....:
        .....
        break;
    
      default:
        break;
    }
  })

  return () => {
    ws.close()
  }
},[])

const whenXXXXendChat = () => {
  // xxx ç‰¹å®šé€»è¾‘
  $ChatSession.next({sessionEnd: ture})
	// xxx ç‰¹å®šé€»è¾‘
}

const closeHandle = () => {
     $ChatSession.subscribe((sessionInfo) => {
        if (sessionInfo.sessionEnd) {
            hideChatWindow();
        }
    });
}

const closeHandle2 = () => {
   whenXXXXendChat()
   $ChatSession.subscribe((sessionInfo) => {
        if (sessionInfo.sessionEnd) {
            hideChatWindow();
        }
    });
}

```

	ä½ ä¼šå‘ç° è§¦å‘ closeHadle2 çš„æ—¶å€™å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯åˆ°äº† closeHandler çš„æ—¶å€™å°±è¯¡å¼‚äº†ï¼Œå®ƒæ°¸è¿œéƒ½ä¸ä¼š è¿›å…¥è¿™ä¸ª ifï¼Œå› ä¸º $ChatSession  æµä¸­å·²ç»æ²¡æ•°æ®äº†ï¼

é‚£ä¹ˆå¦‚ä½•ä¿®å¤è¿™ä¸ªBUGï¼Ÿ

```javascript
const $ChatSession = new BehaviorSubject<{ sessionEnd: boolean }>({ sessionEnd: false});

```

   åªéœ€è¦æ”¹æˆ BehaviorSubject å°±å¥½äº†ï¼Œå®˜æ–¹æ–‡æ¡£() æ¯æ¬¡å®šäºçš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šå…ˆå»å–ä¸€ä¸ªå€¼å‡ºæ¥ï¼

ä½†æ˜¯... è¿™æ ·çš„ç¼–ç¨‹è®¾è®¡çœŸçš„å¥½å—ï¼Ÿè¿™æ ·çš„rxjsä½¿ç”¨çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ

# å…³äº name = initName ?? "Joney"
è¯·é—®è¿™ä¸ªæ—¶å€™ initä¼ é€’äº†ä¸€ä¸ªç©ºï¼Œå®ƒä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

```javascript
const name = initName ?? "Joney";
```

æ³¨æ„ï¼ ç‰¹åˆ«è¦å°å¿ƒè¿™ä¸ªé™·é˜± ï¼Œå½“ä½ çš„initName = " çš„æ—¶å€™ï¼Œå®ƒä¼šæ˜¯ä¸€ä¸ª "" åªæœ‰undefined çš„æ—¶å€™æ‰ä¼šæ˜¯ Joney æ‰€ä»¥ä½ éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œæƒ³æ¸…æ¥šä½ æƒ³è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿ**<font style="color:#DF2A3F;">æ˜¯é»˜è®¤å€¼éƒ½æ˜¯ </font>**Joney**<font style="color:#DF2A3F;">è¿˜æ˜¯å…è®¸å®ƒå‡ºç°  "" çš„æƒ…å†µå‘¢ï¼Ÿ</font>**



# é—®é¢˜ CodePush ERROR_CONFLICT
1. ä¸ºä»€ä¹ˆä¼šæœ‰ ERROR_CONFLICT ï¼Ÿ

   å¯¹äº å‘å¸ƒåŒ…çš„å‘½ä»¤æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯ ç”±äºcode push å†…éƒ¨æ˜¯å¯¹ä¸åŒçš„ç‰ˆæœ¬åŒ…åšäº†ä¸€æ¬¡ Â â€œåŒ…æŒ‡çº¹è¿ç®—â€ï¼Œç”¨ä»¥åˆ¤æ–­èµ„æºæ˜¯å¦é‡å¤ï¼Œå¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ”¹ ä¾ç„¶è¿ç»­çš„ å‘å¸ƒï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯Staging /Production , å¦ä¼šå­˜åœ¨å†²çªï¼ˆä¸Šä¸€ä¸ªç‰ˆæœ¬çš„èµ„æºå·²ç»çº¯åœ¨ï¼Œä¸éœ€è¦å†å‘å¸ƒï¼‰ï¼›

  å¦‚æœä½ è¿˜æƒ³æ”¹ï¼Œé‚£ä¹ˆè¯·ä¿®æ”¹ä½ çš„ä»£ç ï¼Œè®©ä»–ä»¬äº§ç”Ÿä¸€äº› ä¸ä¸€æ ·ï¼Œè¿™æ ·åœ¨ code push çš„ â€œåŒ…æŒ‡çº¹è¿ç®—â€ ä¸­å°±èƒ½ç”Ÿäº§ æ–°çš„ resource äº† ï¼Œäºæ˜¯ä¸ä¼šäº§ç”Ÿ åŒ…å†²çª



2. å¦‚æœå‘å¸ƒçš„å‘½ä»¤é”™äº†æ€ä¹ˆåŠï¼Ÿ

å¦‚æœä½ å‘å¸ƒå‘½ä»¤é”™äº†ï¼Œé‚£ä¹ˆä¸€èˆ¬ æœ‰ä¸¤ç±»ä¿®æ”¹æ–¹å¼ï¼› Â å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬(å»ºè®®ä½¿ç”¨-ç®€å•)/ä½¿ç”¨å›æ»š åŠŸèƒ½



## å¦‚ä½•å¿«é€Ÿé›†æˆ
> ä»SellerAppçš„ç›®å‰çš„ç»éªŒæ¥çœ‹
>

æˆ‘ä»¬æ˜¯é€šè¿‡ä»£ç è¿›è¡Œé›†æˆ ï¼Œä¸æ”¾åˆ° åŸç”Ÿç«¯é‡Œé¢å»ï¼Œä½†æ˜¯åŸç”Ÿç«¯é‡Œé¢ä¹Ÿæ˜¯è¦éµå¾ªå®ƒçš„è§„åˆ™ æ¯”å¦‚1.x.x ç‰ˆæœ¬ï¼Œå’Œ å ä½ç½®çš„ é…ç½®å­—æ®µ å¾—ç•™ç€ 



```tsx
import {Button} from '@ant-design/react-native';
import React from 'react';
import {AppState, Text, View} from 'react-native';
import codePush from 'react-native-code-push';
import {Modal} from '../components/view';
import {Modal as AntdModal} from '@ant-design/react-native';

const codePushStatusDidChange = async (syncStatus: any) => {
  switch (syncStatus) {
    case codePush.SyncStatus.CHECKING_FOR_UPDATE:
      // 0 - æ­£åœ¨æŸ¥è¯¢CodePushæœåŠ¡å™¨ä»¥è¿›è¡Œæ›´æ–°ã€‚
      console.info('[CodePush] Checking for update.');
      break;
    case codePush.SyncStatus.AWAITING_USER_ACTION:
      // 1 - æœ‰å¯ç”¨çš„æ›´æ–°ï¼Œå¹¶ä¸”å‘æœ€ç»ˆç”¨æˆ·æ˜¾ç¤ºäº†ä¸€ä¸ªç¡®è®¤å¯¹è¯æ¡†ã€‚ï¼ˆä»…åœ¨updateDialogä½¿ç”¨æ—¶é€‚ç”¨ï¼‰
      console.info('[CodePush] Awaiting user action.');
      break;
    case codePush.SyncStatus.DOWNLOADING_PACKAGE:
      // 2 - æ­£åœ¨ä»CodePushæœåŠ¡å™¨ä¸‹è½½å¯ç”¨æ›´æ–°ã€‚
      console.info('[CodePush] Downloading package.');
      break;
    case codePush.SyncStatus.INSTALLING_UPDATE:
      // 3 - å·²ä¸‹è½½ä¸€ä¸ªå¯ç”¨çš„æ›´æ–°ï¼Œå¹¶å°†å…¶å®‰è£…ã€‚
      codePush.notifyAppReady();
      console.info('[CodePush] Installing update.');
      break;
    case codePush.SyncStatus.UP_TO_DATE:
      // 4 - åº”ç”¨ç¨‹åºå·²é…ç½®çš„éƒ¨ç½²å®Œå…¨æœ€æ–°ã€‚
      console.info('[CodePush] App is up to date.');
      break;
    case codePush.SyncStatus.UPDATE_IGNORED:
      // 5 è¯¥åº”ç”¨ç¨‹åºå…·æœ‰å¯é€‰æ›´æ–°ï¼Œæœ€ç»ˆç”¨æˆ·é€‰æ‹©å¿½ç•¥è¯¥æ›´æ–°ã€‚ï¼ˆä»…åœ¨updateDialogä½¿ç”¨æ—¶é€‚ç”¨ï¼‰
      console.info('[CodePush] User cancelled the update.');
      break;
    case codePush.SyncStatus.UPDATE_INSTALLED:
      // 6 - å®‰è£…äº†ä¸€ä¸ªå¯ç”¨çš„æ›´æ–°ï¼Œå®ƒå°†æ ¹æ® SyncOptions ä¸­çš„ InstallModeæŒ‡å®šåœ¨ syncStatusChangedCallback å‡½æ•°è¿”å›åç«‹å³æˆ–åœ¨ä¸‹æ¬¡åº”ç”¨æ¢å¤/é‡æ–°å¯åŠ¨æ—¶ç«‹å³è¿è¡Œã€‚
      console.info('[CodePush] Installed update.');
      codePush.notifyAppReady();
      break;
    case codePush.SyncStatus.SYNC_IN_PROGRESS:
      // 7 - æ­£åœ¨æ‰§è¡Œçš„ sync æ“ä½œ
      console.info('[CodePush] Sync already in progress.');
      break;
    case codePush.SyncStatus.UNKNOWN_ERROR:
      // -1 - åŒæ­¥æ“ä½œé‡åˆ°æœªçŸ¥é”™è¯¯ã€‚
      console.info('[CodePush] An unknown error occurred.');
      break;
  }
};

const codePushDownloadDidProgress = (progress: {receivedBytes: number; totalBytes: number}) => {
  const curPercent = ((progress.receivedBytes / progress.totalBytes) * 100).toFixed(0);
  console.log('[CodePushUtils] Downloading Progress', `${curPercent}%`);
};

const syncImmediate = async (deploymentKey: string) => {
  codePush.sync(
    {
      updateDialog: {
        // æ˜¯å¦æ˜¾ç¤ºæ›´æ–°æè¿°
        appendReleaseDescription: true,
        // æ›´æ–°æè¿°çš„å‰ç¼€ã€‚ é»˜è®¤ä¸º"Description"
        descriptionPrefix: '\n\næ›´æ–°å†…å®¹ï¼š\n',
        // å¼ºåˆ¶æ›´æ–°æŒ‰é’®æ–‡å­—ï¼Œé»˜è®¤ä¸ºcontinue
        mandatoryContinueButtonLabel: 'ç«‹å³æ›´æ–°',
        // å¼ºåˆ¶æ›´æ–°æ—¶çš„ä¿¡æ¯. é»˜è®¤ä¸º"An update is available that must be installed."
        mandatoryUpdateMessage: 'å¿…é¡»æ›´æ–°åæ‰èƒ½ä½¿ç”¨',
        // éå¼ºåˆ¶æ›´æ–°æ—¶ï¼ŒæŒ‰é’®æ–‡å­—,é»˜è®¤ä¸º"ignore"
        optionalIgnoreButtonLabel: 'ç¨å',
        // éå¼ºåˆ¶æ›´æ–°æ—¶ï¼Œç¡®è®¤æŒ‰é’®æ–‡å­—. é»˜è®¤ä¸º"Install"
        optionalInstallButtonLabel: 'åå°æ›´æ–°',
        // éå¼ºåˆ¶æ›´æ–°æ—¶ï¼Œæ£€æŸ¥åˆ°æ›´æ–°çš„æ¶ˆæ¯æ–‡æœ¬
        optionalUpdateMessage: 'æœ‰æ–°ç‰ˆæœ¬äº†ï¼Œæ˜¯å¦æ›´æ–°ï¼Ÿ',
        // Alertçª—å£çš„æ ‡é¢˜
        title: 'æ¸©é¦¨æç¤º',
      },
      deploymentKey,
      installMode: codePush.InstallMode.IMMEDIATE,
    },
    codePushStatusDidChange,
    codePushDownloadDidProgress,
  );
};
const showModal = (updateDetail: any, deploymentKey: string) => {
  const {isMandatory, description} = updateDetail;
  Modal.show(
    <AntdModal
      popup={true}
      style={{borderRadius: 12, paddingVertical: 12, width: 331}}
      visible={true}
      maskClosable={false}
      transparent={true}
    >
      <View style={{display: 'flex', marginTop: 0}}>
        <Text>{description}</Text>
        <View style={{flexDirection: 'row', justifyContent: 'center', marginTop: 10}}>
          {!isMandatory && (
            <Button
              onPress={() => {
                Modal.hide();
              }}
            >
              ä¸‹æ¬¡æé†’
            </Button>
          )}
          <Button
            onPress={() => {
              syncImmediate(deploymentKey);
              Modal.hide();
            }}
          >
            åå°æ›´æ–°
          </Button>
        </View>
      </View>
    </AntdModal>,
  );
};

export const checkForUpdate = async (deploymentKey: string) => {
  const update = await codePush.checkForUpdate(deploymentKey);
  // if (update) {
  // showModal(update, deploymentKey);
  syncImmediate(deploymentKey);
  // }
};

export const getUpdateMetadata = async () => {
  return await codePush.getUpdateMetadata(codePush.UpdateState.RUNNING);
};

export const codePushSync = (deploymentKey: string) => {
  AppState.addEventListener('change', (newState) => {
    newState === 'active' && syncImmediate(deploymentKey);
  });
};

```

ğŸŸmbox ç»“åˆ	

```typescript
import AppConfig from '@/config';

import {Platform} from 'react-native';

import {checkForUpdate, getUpdateMetadata} from '@/common/utils/codePushUtils';
import {makeAutoObservable, observable} from 'mobx';

class HotUpdateStore {
  // APPé…ç½®æ–‡ä»¶

  config = AppConfig;

  // çƒ­æ›´æ–°ç¯å¢ƒ

  buildType = '';

  // æ›´æ–°key

  deploymentKey = '';

  // çƒ­æ›´æ–°å†…å®¹
  hotFixData = {};

  constructor() {
    makeAutoObservable(this);
  }

  // è®¾ç½®çƒ­æ›´æ–°
  setHotUpdateConfig = async (config: any, updateBuildType: string) => {
    try {
      this.buildType = updateBuildType;
      if (config && config.codePush) {
        this.config = config;
      }

      const deploymentKey = config.codePush[Platform.OS][updateBuildType];

      checkForUpdate(deploymentKey);
      const meta = await getUpdateMetadata();
      if (meta) {
        this.setHotUpdateData(meta);
      }
    } catch (error) {}
  };
  setHotUpdateData = (data: any) => {
    this.hotFixData = data;
  };
}

const hotUpdateStore = new HotUpdateStore();
export default hotUpdateStore;


```

ç”¨çš„æ—¶å€™ç›´æ¥ç”¨å°±å¥½å•¦

```tsx
  const {setHotUpdateConfig} = useLocalObservable(() => store.hotUpdateStore);
  useEffect(() => {
    setFinish(false);
    const configInit = async () => {
      try {
        let config = localConfig;
        const isDebug = await getStorageDebug();

        if (isDebug === 'true') {
          console.log('é…ç½®å¼€å§‹è½½å…¥');
          const [updateConfig, err] = await fetchConfig(configUrl);
          if (err) {
            console.log(`åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥configUrl:${configUrl}`, err);
          }
          const storageConfig = await fetchStorageConfig();
          config = {
            ...localConfig,
            ...updateConfig,
            ...storageConfig,
          };
        }
        setFinish(true);
        if (__DEV__) {
          // console.log('åˆå¹¶åçš„é…ç½®æ–‡ä»¶', config);
        }
        setConfig(config);
        console.log('222');
        setHotUpdateConfig(config, config?.codePush?.buildType);

        if (config?.codePush?.open && !__DEV__) {
          // çƒ­æ›´æ–°é…ç½®
          console.log('222');
          setHotUpdateConfig(config, config?.codePush?.buildType);
        }
      } catch (error) {
        console.log('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥', error);
      }
    };
    configInit();
  }, []);

// é…ç½®å¦‚ä¸‹ 
......
  codePush: {
    open: true,
    isRelease: true,
    buildType: 'prodction',
    // ios android ï¼ˆstagingã€productionï¼‰éœ€è¦å–æ¶ˆ
    ios: {
      staging: '',
      prodction: '',
    },
    android: {
      staging: '',
      prodction: '',
    },
  },
```

